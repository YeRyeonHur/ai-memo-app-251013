# Story 1.6: 세션 상태 관리

## Status

Draft

---

## Story

**As a** 로그인한 사용자,  
**I want** 페이지를 새로고침하거나 브라우저를 다시 열어도 로그인 상태가 유지되기를 원한다,  
**so that** 매번 로그인할 필요 없이 편리하게 서비스를 이용할 수 있다.

---

## Acceptance Criteria

1. 사용자가 로그인하면 세션이 생성되어 쿠키에 저장되어야 한다
2. 페이지를 새로고침해도 로그인 상태가 유지되어야 한다
3. 브라우저를 닫았다가 다시 열어도 로그인 상태가 유지되어야 한다 (7일간)
4. 세션 만료 시 자동으로 갱신되어야 한다
5. 세션이 유효하지 않을 경우 로그인 페이지로 리디렉션되어야 한다
6. 사용자가 다른 기기에서 로그인하면 각 기기의 세션이 독립적으로 유지되어야 한다
7. 로그아웃 시 현재 기기의 세션만 삭제되어야 한다
8. 보호된 페이지(/notes, /profile 등)는 인증되지 않은 사용자가 접근할 수 없어야 한다

---

## Tasks / Subtasks

- [ ] Task 1: Supabase Auth 세션 설정 확인 및 최적화 (AC: 1, 2, 3)
  - [ ] Supabase 대시보드에서 세션 만료 시간 확인
  - [ ] 세션 쿠키 설정 검증
    - `httpOnly: true` (XSS 방지)
    - `secure: true` (HTTPS 전용)
    - `sameSite: 'lax'` (CSRF 방지)
  - [ ] 세션 만료 시간 설정 (기본 7일, Refresh Token 30일)

- [ ] Task 2: 서버 사이드 세션 검증 미들웨어 (AC: 5, 8)
  - [ ] `/app/middleware.ts` 생성
  - [ ] 보호된 경로 목록 정의 (`/notes`, `/profile`, `/onboarding`)
  - [ ] 요청마다 `supabase.auth.getUser()` 호출하여 세션 검증
  - [ ] 세션 없을 시 `/login`으로 리디렉션 (return NextResponse.redirect)
  - [ ] 세션 유효할 시 요청 계속 진행

- [ ] Task 3: 클라이언트 사이드 세션 상태 관리 (AC: 2, 3)
  - [ ] React Context API 또는 Zustand로 전역 세션 상태 관리
  - [ ] `useAuth` 커스텀 훅 생성
    - `user` (현재 로그인 사용자 정보)
    - `session` (세션 객체)
    - `isLoading` (초기 로딩 상태)
    - `signOut` (로그아웃 함수)
  - [ ] Supabase `onAuthStateChange` 리스너 추가
    - 세션 변경 감지 (로그인, 로그아웃, 토큰 갱신)
    - 상태 업데이트

- [ ] Task 4: 자동 세션 갱신 로직 (AC: 4)
  - [ ] Supabase Auth 자동 토큰 갱신 활성화
  - [ ] Access Token 만료 전 Refresh Token으로 자동 갱신
  - [ ] 갱신 실패 시 로그아웃 처리
  - [ ] 갱신 성공 시 새 토큰으로 쿠키 업데이트

- [ ] Task 5: 다중 기기 세션 관리 (AC: 6)
  - [ ] 각 기기별 독립적인 세션 생성 확인
  - [ ] Supabase Auth의 기본 다중 세션 지원 활용
  - [ ] 세션 목록 조회 기능 (선택 사항)

- [ ] Task 6: 로그아웃 시 세션 삭제 로직 개선 (AC: 7)
  - [ ] `signOut` Server Action 수정
  - [ ] 현재 기기의 세션만 삭제
  - [ ] 쿠키 삭제 (클라이언트 + 서버)
  - [ ] 다른 기기 세션은 유지

- [ ] Task 7: 보호된 라우트 접근 제어 강화 (AC: 8)
  - [ ] `/app/notes/page.tsx` 서버 컴포넌트에서 세션 검증
  - [ ] `/app/profile/page.tsx` (추후 구현 시) 세션 검증
  - [ ] 세션 없을 시 `/login`으로 리디렉션
  - [ ] 에러 메시지 표시 ("로그인이 필요합니다")

- [ ] Task 8: 세션 관리 테스트
  - [ ] 단위 테스트: `useAuth` 훅
  - [ ] 통합 테스트: 세션 갱신 로직
  - [ ] E2E 테스트: 로그인 → 새로고침 → 세션 유지
  - [ ] E2E 테스트: 세션 만료 → 로그인 페이지 리디렉션
  - [ ] E2E 테스트: 로그아웃 → 보호된 페이지 접근 차단

---

## Dev Notes

### 관련 소스 트리 정보

```
app/
  middleware.ts         # 서버 사이드 세션 검증 미들웨어
  (auth)/
    actions.ts          # signOut 개선
  notes/
    page.tsx            # 세션 검증 추가
lib/
  supabase/
    server.ts           # 서버 세션 관리
    client.ts           # 클라이언트 세션 관리
  hooks/
    use-auth.ts         # 커스텀 훅
```

### Supabase Auth 세션 구조

**세션 객체:**
```typescript
{
  access_token: string      // JWT 토큰 (1시간 만료)
  refresh_token: string     // 갱신 토큰 (30일 만료)
  expires_in: number        // 만료 시간 (초)
  expires_at: number        // 만료 타임스탬프
  user: {
    id: string
    email: string
    ...
  }
}
```

**쿠키 구조:**
- `sb-access-token`: Access Token (httpOnly, secure, sameSite=lax)
- `sb-refresh-token`: Refresh Token (httpOnly, secure, sameSite=lax)

### 미들웨어 구현 예시

```typescript
// app/middleware.ts
import { createServerClient } from '@supabase/ssr'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
      },
    }
  )

  const { data: { user } } = await supabase.auth.getUser()

  // 보호된 경로
  const protectedPaths = ['/notes', '/profile', '/onboarding']
  const isProtectedPath = protectedPaths.some(path => 
    request.nextUrl.pathname.startsWith(path)
  )

  if (isProtectedPath && !user) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  return NextResponse.next()
}

export const config = {
  matcher: ['/notes/:path*', '/profile/:path*', '/onboarding/:path*']
}
```

### 자동 토큰 갱신

Supabase는 기본적으로 Access Token 만료 전에 자동으로 Refresh Token을 사용하여 갱신합니다. 별도 구현 불필요하나, 갱신 실패 시 처리 로직 추가:

```typescript
supabase.auth.onAuthStateChange((event, session) => {
  if (event === 'TOKEN_REFRESHED') {
    console.log('Token refreshed successfully')
  } else if (event === 'SIGNED_OUT') {
    // 세션 만료 또는 로그아웃
    router.push('/login')
  }
})
```

### 이전 스토리 참고사항

- Story 1.2: 로그인 시 세션 생성 확인
- Story 1.4: 로그아웃 시 세션 삭제 로직 이미 구현됨

### Testing

#### 테스트 표준
- **테스트 파일 위치**: `lib/hooks/__tests__/`, `app/middleware.test.ts`
- **프레임워크**: Vitest + React Testing Library
- **명명 규칙**: `{hook}.test.ts`, `middleware.test.ts`

#### 테스트 요구사항
1. `useAuth` 훅 테스트 (로그인 상태, 로딩, 로그아웃)
2. 미들웨어 세션 검증 테스트
3. 자동 토큰 갱신 시나리오 테스트
4. 보호된 라우트 접근 제어 테스트
5. 세션 만료 후 리디렉션 테스트
6. 다중 기기 세션 독립성 테스트 (선택 사항)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 작성 | Scrum Master |

---

## Dev Agent Record

_(개발 에이전트가 구현 시 작성)_

### Agent Model Used

_(미정)_

### Debug Log References

_(미정)_

### Completion Notes List

_(미정)_

### File List

_(미정)_

---

## QA Results

_(QA 에이전트가 검토 후 작성)_

