# Story 2.4: 노트 수정 및 실시간 저장

## Status

Ready for Review

---

## Story

**As a** 사용자,  
**I want** 노트를 수정하고 자동으로 저장되기를 원한다,  
**so that** 변경 사항을 잃어버리지 않고 편리하게 노트를 편집할 수 있다.

---

## Acceptance Criteria

1. 노트 상세 페이지에서 "수정" 버튼 클릭 시 노트 편집 페이지(`/notes/[id]/edit`)로 이동해야 한다
2. 노트 편집 페이지는 다음 요소를 포함해야 한다
   - 제목 입력 필드 (기존 제목으로 미리 채워짐)
   - 본문 입력 필드 (기존 본문으로 미리 채워짐)
   - 최대 길이 제한 (제목: 200자)
3. 실시간 자동 저장 기능이 구현되어야 한다
   - 사용자가 입력을 멈춘 후 1초 후 자동 저장 (디바운스)
   - 저장 중 "저장 중..." 상태 표시
   - 저장 완료 시 "저장됨" 상태 표시
   - 저장 실패 시 에러 메시지 표시
4. "완료" 버튼 클릭 시 노트 상세 페이지로 돌아가야 한다
5. "취소" 버튼 클릭 시 노트 상세 페이지로 돌아가야 한다
   - 마지막 자동 저장된 내용이 유지됨
6. 제목 또는 본문이 비어있을 경우 유효성 검증 메시지를 표시해야 한다
   - 자동 저장은 시도하지 않음
7. 비인증 사용자는 노트 편집 페이지에 접근할 수 없어야 한다
8. 다른 사용자의 노트는 수정할 수 없어야 한다
   - 404 페이지로 처리
9. `updated_at` 필드가 자동으로 업데이트되어야 한다
10. 반응형으로 구현되어야 한다

---

## Tasks / Subtasks

- [x] Task 1: 노트 수정 Server Action 구현 (AC: 3, 6, 9)
  - [x] `/app/notes/actions.ts`에 `updateNote` 함수 추가
  - [x] 인증 사용자 확인 (getUser)
  - [x] 입력 데이터 유효성 검증 (제목, 본문 필수)
  - [x] Drizzle ORM으로 노트 업데이트
    - [x] id와 user_id로 필터링 (소유자만 수정 가능)
    - [x] updated_at 자동 업데이트
  - [x] 성공/실패 응답 반환
  - [x] 타입 정의 (UpdateNoteResult)

- [x] Task 2: 노트 편집 폼 컴포넌트 구현 (AC: 2, 3, 6)
  - [x] `/app/notes/[id]/edit/edit-form.tsx` 생성 (Client Component)
  - [x] 제목, 본문 입력 필드
  - [x] React 상태 관리 (title, content)
  - [x] 실시간 자동 저장 로직
    - [x] useDebounce Hook으로 디바운스 구현
    - [x] 1초 후 updateNote 호출
    - [x] 저장 상태 표시 (saving, saved, error)
  - [x] 유효성 검증 (제목, 본문 필수)
  - [x] "완료", "취소" 버튼

- [x] Task 3: 노트 편집 페이지 구현 (AC: 1, 4, 5, 7, 8, 10)
  - [x] `/app/notes/[id]/edit/page.tsx` 생성 (Server Component)
  - [x] 동적 라우트 파라미터 읽기 (params.id)
  - [x] getNoteById Server Action 호출
  - [x] 노트가 없거나 권한이 없으면 notFound()
  - [x] EditForm 컴포넌트에 노트 데이터 전달
  - [x] 반응형 레이아웃

- [x] Task 4: 저장 상태 표시 UI (AC: 3)
  - [x] 저장 상태 인디케이터 컴포넌트
  - [x] "저장 중..." (텍스트 표시)
  - [x] "저장됨 ✓" (체크 표시)
  - [x] "저장 실패" (에러 표시)
  - [x] 페이지 상단에 표시

- [x] Task 5: 디바운스 유틸리티 또는 Hook (AC: 3)
  - [x] `useDebounce` 커스텀 Hook 구현
  - [x] 1초 디바운스 타이머
  - [x] 클린업 함수로 타이머 정리

- [x] Task 6: 404 처리 (AC: 8)
  - [x] `/app/notes/[id]/edit/not-found.tsx` 생성
  - [x] "노트를 찾을 수 없습니다" 메시지

- [x] Task 7: 테스트 작성
  - [x] `/app/notes/actions.test.ts`에 updateNote 테스트 추가
    - [x] 인증 사용자가 자신의 노트 수정 성공
    - [x] 다른 사용자의 노트 수정 실패
    - [x] 제목/본문 누락 시 유효성 검증 실패
    - [x] updated_at 필드 업데이트 확인
  - [x] `/lib/hooks/__tests__/use-debounce.test.ts` 생성
    - [x] useDebounce Hook 기본 동작 테스트
  - [x] 편집 폼 컴포넌트 테스트 (선택적) - 스킵

---

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/2.3.story.md]
- 노트 상세 조회 기능 구현 완료 (`getNoteById` Server Action)
- 노트 상세 페이지에 "수정" 버튼 구현 완료
- date-fns 라이브러리 사용 중

[Source: docs/stories/2.1.story.md]
- 노트 생성 기능 구현 완료 (`createNote` Server Action)
- 제목/본문 입력 폼 구현 경험 있음
- 유효성 검증 로직 재사용 가능

### 기술 스택

[Source: docs/architecture.md#1-기술-스택]
- **프레임워크**: Next.js (App Router, Server Actions)
- **UI**: shadcn/ui + Tailwind CSS + Radix UI
- **DB/인증**: Supabase (Postgres, Auth)
- **ORM**: Drizzle ORM

### 데이터 모델 (notes 테이블)

[Source: drizzle/schema.ts]
- **notes 테이블 스키마**:
  - `id`: UUID, primary key
  - `user_id`: UUID, not null
  - `title`: text, not null
  - `content`: text, not null
  - `created_at`: timestamp, 기본값 now()
  - `updated_at`: timestamp, 기본값 now()
- **updated_at 자동 업데이트**: Drizzle ORM의 `.set()` 메서드 사용 시 자동으로 현재 시간으로 업데이트되도록 구현 필요

### 서버 액션

[Source: docs/architecture.md#4-서버-액션]
- `saveNote` – 노트 작성/수정 (이 스토리에서 updateNote로 구현)
- `updateNote` – 노트 수정 (이 스토리에서 구현)

### 보안 및 권한

[Source: docs/architecture.md#3-보안]
- **권한 스코프**: 노트는 사용자 ID 스코프로 소유자만 수정 가능
- **인증**: Supabase Auth 사용 (`getUser`로 현재 사용자 확인)
- id와 user_id 모두로 필터링하여 다른 사용자의 노트 수정 방지

### 실시간 자동 저장 전략

- **디바운스**: 사용자가 입력을 멈춘 후 1초 대기
- **useEffect Hook**: title, content 상태 변경 감지
- **타이머 정리**: 컴포넌트 언마운트 또는 새 입력 시 이전 타이머 취소
- **저장 상태**: saving, saved, error 세 가지 상태 관리

### 디바운스 Hook 예시

```typescript
function useDebounce<T>(value: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value)

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value)
    }, delay)

    return () => {
      clearTimeout(handler)
    }
  }, [value, delay])

  return debouncedValue
}
```

### updated_at 필드 업데이트

- **Drizzle ORM**: `.update()` 메서드 사용 시 `updated_at`을 현재 시간으로 명시적으로 설정
- **예시**: `.set({ title, content, updatedAt: new Date() })`
- 또는 DB 레벨에서 트리거 사용 (선택적)

### 프로젝트 구조

[Source: project layout]
- **노트 편집 페이지**: `/app/notes/[id]/edit/` 디렉토리
  - `/app/notes/[id]/edit/page.tsx` - 노트 편집 페이지 (새로 생성)
  - `/app/notes/[id]/edit/edit-form.tsx` - 편집 폼 컴포넌트 (새로 생성)
  - `/app/notes/[id]/edit/not-found.tsx` - 404 페이지 (새로 생성)
- **Server Actions**: `/app/notes/actions.ts` (updateNote 추가)
- **Custom Hooks**: `/lib/hooks/use-debounce.ts` (새로 생성)

### 파일 길이 제한

[Source: 프로젝트 규칙]
- 모든 파일은 **500 LOC 이하** 유지
- 파일은 모듈화되고 단일 목적을 가져야 함

### 주석 규칙

[Source: 프로젝트 규칙]
- 모든 파일은 **4줄의 헤더 주석**으로 시작:
  1. 코드베이스 내 정확한 파일 위치
  2. 이 파일이 무엇을 하는지 설명
  3. 이 파일이 왜 존재하는지 설명
  4. 관련된 2~4개 파일 목록

### UX 고려사항

- 자동 저장 중에는 폼 제출 버튼 비활성화 (선택적)
- 네트워크 에러 시 재시도 로직 (선택적)
- 저장 상태를 사용자에게 명확히 표시
- 취소 버튼 클릭 시 확인 없이 바로 돌아가기 (마지막 자동 저장된 내용 유지)

---

## Testing

### 테스트 표준

[Source: 프로젝트 규칙]
- **테스트 프레임워크**: Vitest
- **테스트 파일 위치**: `__tests__/` 디렉토리 또는 동일 위치에 `.test.ts`
- **테스트 커버리지 목표**: 80% 이상

### 테스트 항목

1. **Server Action 테스트** (`/app/notes/actions.test.ts`에 추가)
   - `updateNote` 함수 유닛 테스트
   - 인증된 사용자가 자신의 노트 수정 성공
   - 다른 사용자의 노트 수정 시 실패
   - 제목/본문 누락 시 유효성 검증 실패
   - updated_at 필드가 업데이트되는지 확인

2. **디바운스 Hook 테스트** (`/lib/hooks/__tests__/use-debounce.test.ts`)
   - useDebounce Hook 동작 테스트
   - 디바운스 타이머 테스트
   - 클린업 테스트

3. **편집 폼 컴포넌트 테스트** (선택적)
   - 폼이 올바르게 렌더링되는지 확인
   - 자동 저장이 트리거되는지 확인
   - 저장 상태 표시 확인

---

## Change Log

| Date       | Version | Description              | Author     |
|------------|---------|--------------------------|------------|
| 2025-10-14 | 1.0     | Story 2.4 초안 작성      | Bob (SM)   |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

없음

### Completion Notes List

- updateNote Server Action 구현 완료
- useDebounce 커스텀 Hook 구현 완료
- 노트 편집 폼 컴포넌트 구현 완료 (실시간 자동 저장 기능)
- 노트 편집 페이지 구현 완료
- 404 페이지 구현 완료
- 저장 상태 표시 UI 구현 완료
- 모든 테스트 통과 (108 tests passed)

### File List

- `app/notes/actions.ts` - updateNote Server Action 추가
- `app/notes/[id]/edit/page.tsx` - 노트 편집 페이지 (생성)
- `app/notes/[id]/edit/edit-form.tsx` - 편집 폼 컴포넌트 (생성)
- `app/notes/[id]/edit/not-found.tsx` - 404 페이지 (생성)
- `lib/hooks/use-debounce.ts` - useDebounce Hook (생성)
- `app/notes/actions.test.ts` - updateNote 테스트 추가
- `lib/hooks/__tests__/use-debounce.test.ts` - useDebounce 테스트 (생성)

---

## QA Results

_(QA 에이전트가 검토 후 작성)_

