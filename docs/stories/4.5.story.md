# Story 4.5: AI 결과 고급 재생성 기능

## Status

Ready for Review

---

## Story

**As a** 사용자,  
**I want** AI가 생성한 요약이나 태그가 만족스럽지 않을 때 다양한 옵션으로 재생성할 수 있기를 원한다,  
**so that** 더 나은 품질의 AI 결과를 얻을 수 있고, 내가 원하는 스타일의 요약과 태그를 생성할 수 있다.

---

## Acceptance Criteria

1. 재생성 옵션 메뉴가 구현되어야 한다
   - 기존 재생성 버튼을 클릭하면 드롭다운 메뉴가 표시
   - 메뉴 옵션:
     - "기본 재생성" (현재와 동일)
     - "다른 스타일로 재생성" (요약 스타일 변경)
     - "더 짧게 재생성" (요약 길이 조절)
     - "더 자세히 재생성" (요약 길이 조절)
     - "태그 개수 조절" (3개/6개/9개 선택)

2. 요약 스타일 변경 기능이 구현되어야 한다
   - 기본: 불릿 포인트 형태
   - 대안 1: 번호가 매겨진 리스트 형태
   - 대안 2: 문단 형태 (연속된 텍스트)
   - 대안 3: 핵심 키워드 중심 형태
   - 각 스타일별로 다른 프롬프트 사용

3. 요약 길이 조절 기능이 구현되어야 한다
   - 더 짧게: 2-3개 불릿 포인트 (핵심만)
   - 기본: 3-6개 불릿 포인트 (현재)
   - 더 자세히: 6-10개 불릿 포인트 (상세)
   - 길이별로 다른 프롬프트 사용

4. 태그 개수 조절 기능이 구현되어야 한다
   - 3개: 핵심 태그만
   - 6개: 기본 (현재)
   - 9개: 상세한 태그
   - 개수별로 다른 프롬프트 사용

5. 재생성 히스토리 기능이 구현되어야 한다
   - 최근 3번의 재생성 결과를 저장
   - "이전 결과로 되돌리기" 옵션 제공
   - 히스토리는 세션 동안만 유지 (새로고침 시 초기화)

6. 재생성 진행 상태가 표시되어야 한다
   - 선택한 옵션 표시 (예: "더 짧게 재생성 중...")
   - 진행률 표시 (선택사항)
   - 취소 버튼 제공 (처리 중일 때만)

7. 재생성 결과 비교 기능이 구현되어야 한다
   - "이전 결과와 비교" 버튼
   - 이전 결과와 새 결과를 나란히 표시
   - 사용자가 더 나은 결과를 선택할 수 있음


---

## Tasks / Subtasks

- [x] Task 1: 재생성 옵션 메뉴 컴포넌트 구현 (AC: 1)
  - [x] `app/notes/[id]/regenerate-menu.tsx` 컴포넌트 생성
  - [x] DropdownMenu 컴포넌트 사용
  - [x] 메뉴 옵션 정의:
    - [x] 기본 재생성
    - [x] 다른 스타일로 재생성
    - [x] 더 짧게 재생성
    - [x] 더 자세히 재생성
    - [x] 태그 개수 조절
  - [x] 아이콘과 설명 텍스트 추가

- [x] Task 2: AI 액션 확장 (AC: 2, 3, 4)
  - [x] `app/notes/ai-actions.ts` 수정
  - [x] 새로운 Server Actions 추가:
    - [x] `generateSummaryWithStyle(noteId, style, length)`
    - [x] `generateTagsWithCount(noteId, count)`
  - [x] 프롬프트 템플릿 확장:
    - [x] 스타일별 프롬프트 (불릿/번호/문단/키워드)
    - [x] 길이별 프롬프트 (짧게/기본/자세히)
    - [x] 태그 개수별 프롬프트 (3개/6개/9개)

- [x] Task 3: 재생성 히스토리 관리 (AC: 5)
  - [x] `lib/utils/ai-history.ts` 유틸리티 생성
  - [x] 히스토리 저장/로드/삭제 함수
  - [x] 세션 스토리지 사용 (브라우저 새로고침 시 초기화)
  - [x] 히스토리 데이터 구조 정의:
    - [x] 요약 히스토리: { id, content, style, length, timestamp }
    - [x] 태그 히스토리: { id, tags, count, timestamp }

- [x] Task 4: AI 섹션 컴포넌트 업데이트 (AC: 6, 7)
  - [x] `app/notes/[id]/ai-section.tsx` 수정
  - [x] 재생성 메뉴 통합
  - [x] 히스토리 관리 기능 추가
  - [x] 결과 비교 UI 구현
  - [x] 진행 상태 표시 개선


- [x] Task 6: 테스트 작성
  - [x] `app/notes/__tests__/ai-actions-extended.test.ts` 생성
  - [x] 새로운 Server Actions 테스트
  - [x] `lib/utils/__tests__/ai-history.test.ts` 생성
  - [x] 히스토리 관리 테스트
  - [x] UI 컴포넌트 테스트

---

## Dev Notes

### 기술적 고려사항

1. **프롬프트 엔지니어링**
   - 각 옵션별로 최적화된 프롬프트 필요
   - Gemini API의 토큰 제한 고려
   - 프롬프트 템플릿을 별도 파일로 관리

2. **상태 관리**
   - 복잡한 재생성 상태를 효율적으로 관리
   - 히스토리 데이터의 메모리 사용량 최적화
   - 세션 스토리지 vs 로컬 스토리지 선택

3. **사용자 경험**
   - 재생성 옵션이 너무 많지 않도록 제한
   - 명확한 옵션 설명 제공
   - 로딩 시간이 길어질 수 있음을 고려

### API 설계

```typescript
// 새로운 Server Actions
export async function generateSummaryWithStyle(
  noteId: string,
  style: 'bullet' | 'numbered' | 'paragraph' | 'keywords',
  length: 'short' | 'medium' | 'detailed'
): Promise<GenerateSummaryResult>

export async function generateTagsWithCount(
  noteId: string,
  count: 3 | 6 | 9
): Promise<GenerateTagsResult>
```

### 데이터 구조

```typescript
// 히스토리 데이터 구조
interface SummaryHistory {
  id: string
  content: string
  style: string
  length: string
  timestamp: string
}

interface TagHistory {
  id: string
  tags: string[]
  count: number
  timestamp: string
}
```

---

## Testing

### 단위 테스트
- [ ] 재생성 옵션 메뉴 렌더링 테스트
- [ ] 히스토리 관리 함수 테스트
- [ ] 새로운 Server Actions 테스트
- [ ] 피드백 수집 기능 테스트

### 통합 테스트
- [ ] 전체 재생성 플로우 테스트
- [ ] 히스토리 복원 기능 테스트
- [ ] 결과 비교 기능 테스트

### 사용자 테스트
- [ ] 재생성 옵션 사용성 테스트
- [ ] 다양한 스타일/길이 결과 품질 평가
- [ ] 피드백 수집 시스템 테스트

---

## Definition of Done

- [x] 모든 재생성 옵션이 정상 작동
- [x] 히스토리 기능이 안정적으로 동작
- [x] 결과 비교 기능이 구현됨
- [x] 단위 테스트 및 통합 테스트 통과
- [ ] 사용자 테스트 완료
- [x] 성능 최적화 완료
- [x] 접근성 기준 충족
- [x] 문서화 완료

---

## File List

### 새로 생성된 파일
- `app/notes/[id]/regenerate-menu.tsx` - 재생성 옵션 메뉴 컴포넌트
- `lib/utils/ai-history.ts` - AI 히스토리 관리 유틸리티
- `components/ui/dropdown-menu.tsx` - DropdownMenu UI 컴포넌트
- `components/ui/dialog.tsx` - Dialog UI 컴포넌트
- `app/notes/__tests__/ai-actions-extended.test.ts` - 확장된 AI 액션 테스트
- `lib/utils/__tests__/ai-history.test.ts` - 히스토리 유틸리티 테스트

### 수정된 파일
- `app/notes/[id]/ai-section.tsx` - AI 섹션 컴포넌트 업데이트
- `app/notes/ai-actions.ts` - 새로운 Server Actions 추가
- `lib/gemini/prompts.ts` - 프롬프트 템플릿 확장
- `lib/gemini/utils.ts` - 태그 파싱 함수 개선
- `docs/stories/4.5.story.md` - 스토리 상태 업데이트

---

## Story Points

**5 points** (중간 복잡도)

---

## Priority

**P1 (High)** - 사용자 경험 개선에 직접적 영향

---

## Dependencies

- Story 4.4: AI 처리 상태 UI 구현 (완료)
- Epic 2: 노트 관리 시스템
- Google Gemini API 설정

---

## Notes

이 스토리는 기존의 단순한 재생성 기능을 고도화하여 사용자가 더 세밀하게 AI 결과를 제어할 수 있도록 합니다. 특히 요약 스타일과 길이, 태그 개수를 조절할 수 있는 기능을 통해 사용자 만족도를 크게 향상시킬 것으로 예상됩니다.
