# Story 1.7: 인증 에러 핸들링

## Status

Draft

---

## Story

**As a** 사용자,  
**I want** 인증 과정에서 발생하는 에러를 명확하게 이해하고 해결 방법을 알고 싶다,  
**so that** 로그인/회원가입 실패 시 무엇이 잘못되었는지 파악하고 적절히 대응할 수 있다.

---

## Acceptance Criteria

1. 모든 인증 에러는 사용자 친화적인 한글 메시지로 표시되어야 한다
2. 에러 메시지는 구체적이어야 하며, 해결 방법을 제시해야 한다
3. 네트워크 에러 발생 시 재시도 옵션을 제공해야 한다
4. 이메일 형식 오류, 비밀번호 요구사항 미충족 등 클라이언트 검증 에러는 즉시 표시되어야 한다
5. 서버 에러(Supabase Auth 에러)는 적절히 처리되고 사용자에게 안내되어야 한다
6. 보안상 민감한 정보(예: "해당 이메일 존재 여부")는 노출하지 않아야 한다
7. 에러 발생 시 로그를 서버에 기록하여 디버깅에 활용할 수 있어야 한다
8. 에러 메시지는 Toast 알림 또는 인라인 메시지로 표시되어야 한다

---

## Tasks / Subtasks

- [ ] Task 1: 인증 에러 타입 정의 및 매핑 (AC: 1, 2)
  - [ ] `lib/errors/auth-errors.ts` 생성
  - [ ] Supabase Auth 에러 코드 → 한글 메시지 매핑
    - `invalid_credentials` → "이메일 또는 비밀번호가 올바르지 않습니다"
    - `email_exists` → "이미 사용 중인 이메일입니다"
    - `weak_password` → "비밀번호가 너무 약합니다. 8자 이상, 특수문자 포함 필수"
    - `invalid_email` → "유효하지 않은 이메일 형식입니다"
    - `network_error` → "네트워크 연결을 확인해주세요"
    - `email_provider_disabled` → "이메일 로그인이 비활성화되었습니다. 관리자에게 문의하세요"
    - `session_expired` → "세션이 만료되었습니다. 다시 로그인해주세요"
  - [ ] 에러 타입 인터페이스 정의
  - [ ] 에러 메시지 헬퍼 함수 작성 (`getAuthErrorMessage`)

- [ ] Task 2: 클라이언트 사이드 폼 검증 에러 처리 (AC: 4)
  - [ ] React Hook Form 에러 메시지 커스터마이징
  - [ ] Zod 스키마 에러 메시지 한글화
    - 이메일 형식 오류
    - 비밀번호 길이 오류
    - 비밀번호 불일치 오류
    - 특수문자 미포함 오류
  - [ ] 실시간 검증 피드백 (입력 중 에러 표시)

- [ ] Task 3: 서버 사이드 에러 처리 개선 (AC: 5, 6, 7)
  - [ ] `app/(auth)/actions.ts` 수정
  - [ ] 모든 Server Action에 try-catch 추가
  - [ ] Supabase Auth 에러 처리
    - 에러 코드 추출
    - 매핑된 한글 메시지 반환
    - 보안 고려: 이메일 존재 여부 노출 방지
  - [ ] 서버 로그 기록
    - `console.error` 또는 로깅 라이브러리 사용
    - 에러 스택 트레이스 기록
    - 사용자 ID, 타임스탬프 포함

- [ ] Task 4: 네트워크 에러 처리 및 재시도 (AC: 3)
  - [ ] 네트워크 에러 감지
  - [ ] 재시도 버튼 UI 추가
  - [ ] 재시도 로직 구현 (최대 3회)
  - [ ] 재시도 실패 시 에러 메시지 표시

- [ ] Task 5: 에러 표시 UI 컴포넌트 (AC: 8)
  - [ ] Toast 알림 사용 (기존 sonner 활용)
  - [ ] 인라인 에러 메시지 컴포넌트 작성
  - [ ] 에러 심각도에 따른 스타일 적용
    - 경고 (노란색): 클라이언트 검증 오류
    - 에러 (빨간색): 서버 오류, 네트워크 오류

- [ ] Task 6: 에러 핸들링 일관성 유지 (AC: 1, 2)
  - [ ] 모든 인증 페이지에 에러 핸들링 적용
    - 회원가입 (`/signup`)
    - 로그인 (`/login`)
    - 비밀번호 찾기 (`/forgot-password`)
    - 비밀번호 재설정 (`/reset-password`)
  - [ ] 공통 에러 핸들러 함수 작성
  - [ ] 에러 메시지 일관성 검증

- [ ] Task 7: 에러 로깅 시스템 구축 (AC: 7)
  - [ ] 에러 로그 포맷 정의
    ```json
    {
      "timestamp": "2025-10-14T12:00:00Z",
      "level": "error",
      "type": "auth_error",
      "code": "invalid_credentials",
      "user_id": "uuid",
      "message": "Login failed",
      "stack": "..."
    }
    ```
  - [ ] 로그 저장 위치 결정 (콘솔 / 파일 / 외부 서비스)
  - [ ] (선택) Sentry 연동 준비

- [ ] Task 8: 에러 핸들링 테스트
  - [ ] 단위 테스트: `getAuthErrorMessage` 함수
  - [ ] 단위 테스트: Zod 스키마 검증 에러
  - [ ] 통합 테스트: Server Action 에러 처리
  - [ ] E2E 테스트: 잘못된 자격 증명 로그인 시도
  - [ ] E2E 테스트: 중복 이메일 회원가입 시도
  - [ ] E2E 테스트: 네트워크 에러 시나리오 (Mock)

---

## Dev Notes

### 관련 소스 트리 정보

```
app/
  (auth)/
    actions.ts          # 에러 처리 로직 추가
    login/page.tsx      # 에러 표시 UI
    signup/page.tsx     # 에러 표시 UI
    forgot-password/page.tsx
    reset-password/page.tsx
lib/
  errors/
    auth-errors.ts      # 에러 타입 정의 및 매핑
  hooks/
    use-auth.ts         # 에러 핸들링 추가
components/
  ui/
    error-message.tsx   # 에러 메시지 컴포넌트
```

### 에러 매핑 예시

```typescript
// lib/errors/auth-errors.ts
export const AUTH_ERROR_MESSAGES: Record<string, string> = {
  invalid_credentials: '이메일 또는 비밀번호가 올바르지 않습니다 🔑',
  email_exists: '이미 사용 중인 이메일입니다 📧',
  weak_password: '비밀번호가 너무 약합니다. 8자 이상, 특수문자 포함 필수 🔒',
  invalid_email: '유효하지 않은 이메일 형식입니다 ✉️',
  network_error: '네트워크 연결을 확인해주세요 📡',
  email_provider_disabled: '이메일 로그인이 비활성화되었습니다. 관리자에게 문의하세요 🚫',
  session_expired: '세션이 만료되었습니다. 다시 로그인해주세요 ⏰',
  unknown_error: '오류가 발생했습니다. 잠시 후 다시 시도해주세요 ⚠️'
}

export function getAuthErrorMessage(errorCode: string): string {
  return AUTH_ERROR_MESSAGES[errorCode] || AUTH_ERROR_MESSAGES.unknown_error
}
```

### 서버 에러 처리 패턴

```typescript
// app/(auth)/actions.ts
export async function signInWithEmail(data: { email: string; password: string }) {
  try {
    const supabase = await createClient()
    const { data: authData, error } = await supabase.auth.signInWithPassword({
      email: data.email,
      password: data.password,
    })

    if (error) {
      // 에러 로그 기록
      console.error('Login error:', {
        code: error.code,
        message: error.message,
        timestamp: new Date().toISOString()
      })

      // 보안 고려: 이메일 존재 여부 노출 방지
      if (error.code === 'invalid_credentials') {
        return { error: { message: getAuthErrorMessage('invalid_credentials') } }
      }

      return { error: { message: getAuthErrorMessage(error.code || 'unknown_error') } }
    }

    redirect('/notes')
  } catch (error) {
    console.error('Unexpected error:', error)
    return { error: { message: getAuthErrorMessage('unknown_error') } }
  }
}
```

### 클라이언트 검증 에러 한글화

```typescript
// Zod 스키마 에러 메시지
const signUpFormSchema = z.object({
  email: z.string().email({ message: '유효한 이메일 주소를 입력해주세요 ✉️' }),
  password: z
    .string()
    .min(8, { message: '비밀번호는 최소 8자 이상이어야 합니다 🔒' })
    .regex(/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/, {
      message: '비밀번호는 특수문자를 1개 이상 포함해야 합니다 🔐',
    }),
})
```

### 이전 스토리 참고사항

- Story 1.1, 1.2, 1.3, 1.4: 기존 에러 처리 로직 개선 필요
- 모든 Server Action에 일관된 에러 핸들링 적용

### Testing

#### 테스트 표준
- **테스트 파일 위치**: `lib/errors/__tests__/`, `app/(auth)/__tests__/`
- **프레임워크**: Vitest + React Testing Library
- **명명 규칙**: `{module}.test.ts`

#### 테스트 요구사항
1. 에러 메시지 매핑 함수 테스트
2. Zod 스키마 검증 에러 테스트
3. Server Action 에러 핸들링 테스트
4. 네트워크 에러 재시도 로직 테스트
5. Toast 알림 표시 테스트
6. 보안 검증: 이메일 존재 여부 노출 방지 테스트

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 초안 작성 | Scrum Master |

---

## Dev Agent Record

_(개발 에이전트가 구현 시 작성)_

### Agent Model Used

_(미정)_

### Debug Log References

_(미정)_

### Completion Notes List

_(미정)_

### File List

_(미정)_

---

## QA Results

_(QA 에이전트가 검토 후 작성)_

