# Story 4.1: Gemini API 설정 및 연동

## Status

Ready for Review

---

## Story

**As a** 개발자,  
**I want** Google Gemini API를 프로젝트에 연동하고 기본 설정을 완료하기를 원한다,  
**so that** 노트 요약 및 태깅 기능을 구현할 수 있는 기반을 마련할 수 있다.

---

## Acceptance Criteria

1. Google AI SDK (`@google/genai`) 패키지가 설치되어야 한다
   - package.json에 의존성 추가
   - pnpm을 사용하여 설치

2. 환경변수 설정이 완료되어야 한다
   - `.env.local`에 `GEMINI_API_KEY` 추가
   - API 키는 서버 사이드에서만 접근 가능 (NEXT_PUBLIC_ 접두사 없음)
   - .env.example에 환경변수 예시 추가

3. Gemini API 클라이언트 초기화 모듈이 구현되어야 한다
   - `lib/gemini/client.ts` 파일 생성
   - `GoogleGenAI` 클라이언트 초기화
   - API 키 누락 시 명확한 에러 메시지
   - 모델 설정: `gemini-2.0-flash` 사용

4. Gemini API 연결 테스트 함수가 구현되어야 한다
   - 간단한 텍스트 생성 테스트
   - 연결 성공/실패 여부 확인
   - 에러 핸들링 및 타임아웃 처리

5. 타입 정의가 완료되어야 한다
   - Gemini API 응답 타입 정의
   - 에러 타입 정의
   - TypeScript 타입 안전성 확보

6. 에러 핸들링 유틸리티가 구현되어야 한다
   - API 키 누락 에러
   - 네트워크 에러
   - 레이트 리미트 에러
   - 토큰 제한 초과 에러
   - 타임아웃 에러

7. 단위 테스트가 작성되어야 한다
   - Gemini 클라이언트 초기화 테스트
   - API 키 검증 테스트
   - 에러 핸들링 테스트
   - Mocking을 사용한 독립적인 테스트

8. 문서화가 완료되어야 한다
   - API 키 발급 방법 (README 또는 주석)
   - 사용 예시 코드
   - 에러 처리 가이드

---

## Tasks / Subtasks

- [x] Task 1: Google AI SDK 설치 및 환경 설정 (AC: 1, 2)
  - [x] `@google/genai` 패키지 설치
    ```bash
    pnpm add @google/genai
    ```
  - [x] `.env.local`에 `GEMINI_API_KEY` 환경변수 추가
  - [x] `.env.example` 파일 생성 또는 업데이트
    - [x] Gemini API 키 예시 추가
    - [x] API 키 발급 방법 주석으로 설명

- [x] Task 2: Gemini 클라이언트 모듈 구현 (AC: 3, 5)
  - [x] `lib/gemini/client.ts` 파일 생성
  - [x] GoogleGenAI 클라이언트 초기화 함수 구현
    - [x] 환경변수에서 API 키 로드 (`GEMINI_API_KEY`)
    - [x] API 키 누락 시 에러 throw
    - [x] 모델 설정: `gemini-2.0-flash`
    - [x] 초기화 예시:
      ```typescript
      import { GoogleGenAI } from '@google/genai';
      const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });
      ```
  - [x] TypeScript 타입 정의
    - [x] `lib/gemini/types.ts` 파일 생성
    - [x] GeminiResponse 타입 정의
    - [x] GeminiError 타입 정의
    - [x] GenerateContentConfig 타입 정의

- [x] Task 3: 에러 핸들링 유틸리티 구현 (AC: 6)
  - [x] `lib/gemini/errors.ts` 파일 생성
  - [x] 커스텀 에러 클래스 정의
    - [x] GeminiAPIKeyMissingError
    - [x] GeminiNetworkError
    - [x] GeminiRateLimitError
    - [x] GeminiTokenLimitError
    - [x] GeminiTimeoutError
  - [x] 에러 파싱 유틸리티 함수
    - [x] parseGeminiError(error: unknown): GeminiError
    - [x] 사용자 친화적인 에러 메시지 매핑

- [x] Task 4: API 연결 테스트 함수 구현 (AC: 4)
  - [x] `lib/gemini/test-connection.ts` 파일 생성
  - [x] testGeminiConnection() 함수 구현
    - [x] 간단한 프롬프트로 텍스트 생성 테스트
    - [x] 타임아웃 설정 (10초)
    - [x] 성공/실패 결과 반환
    - [x] 상세 에러 정보 포함

- [x] Task 5: 헬퍼 함수 구현
  - [x] `lib/gemini/utils.ts` 파일 생성
  - [x] 토큰 카운팅 유틸리티 (선택)
  - [x] 프롬프트 검증 함수
    - [x] 빈 프롬프트 체크
    - [x] 최대 길이 체크 (8k 토큰 제한 고려)

- [x] Task 6: 단위 테스트 작성 (AC: 7)
  - [x] `lib/gemini/__tests__/client.test.ts` 생성
    - [x] Gemini 클라이언트 초기화 테스트
    - [x] API 키 누락 시 에러 발생 테스트
    - [x] 모델 설정 검증 테스트
  - [x] `lib/gemini/__tests__/errors.test.ts` 생성
    - [x] 각 에러 타입별 테스트
    - [x] parseGeminiError 함수 테스트
  - [x] `lib/gemini/__tests__/test-connection.test.ts` 생성
    - [x] 연결 테스트 성공 시나리오
    - [x] 연결 테스트 실패 시나리오
    - [x] 타임아웃 테스트
  - [x] Vitest mocking 활용
    - [x] GoogleGenAI 클래스 모킹
    - [x] 환경변수 모킹 (GEMINI_API_KEY)

- [x] Task 7: 문서화 (AC: 8)
  - [x] README에 Gemini API 설정 섹션 추가
    - [x] API 키 발급 방법 (Google AI Studio)
    - [x] 환경변수 설정 방법
    - [x] 사용 예시
  - [x] 코드 주석 추가
    - [x] 각 함수에 JSDoc 주석
    - [x] 에러 처리 방법 설명

- [x] Task 8: 수동 테스트 및 검증
  - [x] API 키 발급 및 설정
  - [x] 로컬 환경에서 연결 테스트 실행
  - [x] 에러 시나리오 수동 테스트
    - [x] API 키 누락
    - [x] 잘못된 API 키
    - [x] 네트워크 끊김 시뮬레이션
  - [x] 모든 단위 테스트 통과 확인 (62/62 테스트 통과)

---

## Dev Notes

### 기술 스택 및 아키텍처 정보

#### Google Gemini API 개요
- **모델**: `gemini-2.0-flash` (빠른 응답 속도, 무료 할당량)
- **SDK**: `@google/genai` (공식 Node.js SDK)
- **패키지 설치**: `pnpm add @google/genai`
- **환경변수**: `GEMINI_API_KEY` (또는 `GOOGLE_API_KEY`)
- **토큰 제한**: 8k 토큰 (입력 + 출력 합계)
- **사용 사례**: 텍스트 요약, 태그 생성

[Source: docs/prd.md, docs/architecture.md, Context7: /googleapis/js-genai]

#### 프로젝트 구조
```
lib/
  gemini/
    client.ts        # Gemini API 클라이언트 초기화
    types.ts         # TypeScript 타입 정의
    errors.ts        # 커스텀 에러 클래스
    utils.ts         # 헬퍼 함수
    test-connection.ts  # 연결 테스트
    __tests__/
      client.test.ts
      errors.test.ts
      test-connection.test.ts
```

[Source: 기존 프로젝트 구조 패턴 참고]

#### 환경변수 관리
- 기존 패턴: `.env.local` 파일 사용
- Supabase 키 패턴 참고:
  - 서버 전용 키: `SUPABASE_SERVICE_ROLE_KEY` (NEXT_PUBLIC_ 없음)
  - 클라이언트 키: `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- Gemini API 키는 **서버 전용**이므로 `GEMINI_API_KEY` (접두사 없음)
- SDK는 자동으로 `GEMINI_API_KEY` 또는 `GOOGLE_API_KEY` 환경변수를 인식

[Source: .env.local 기존 설정, Context7: /googleapis/js-genai]

#### Server Actions 패턴
- 기존 Server Actions 위치: `app/*/actions.ts`
- 패턴:
  ```typescript
  'use server'
  
  import { createClient } from '@/lib/supabase/server'
  
  export async function someAction() {
    try {
      // 1. 인증 확인
      const supabase = await createClient()
      const { data: { user }, error } = await supabase.auth.getUser()
      
      if (error || !user) {
        return { success: false, error: '인증되지 않은 사용자입니다.' }
      }
      
      // 2. 비즈니스 로직
      // ...
      
      return { success: true, data: result }
    } catch (error) {
      console.error('에러:', error)
      return { success: false, error: '에러 메시지' }
    }
  }
  ```

[Source: app/notes/actions.ts, app/(auth)/actions.ts]

#### 에러 핸들링 패턴
- 기존 에러 핸들링 예시: `lib/errors/auth-errors.ts`
- 커스텀 에러 클래스 + 에러 파싱 함수 패턴 사용
- 사용자 친화적인 한국어 에러 메시지

[Source: lib/errors/auth-errors.ts]

#### API 클라이언트 패턴
- 기존 클라이언트 예시: `lib/supabase/client.ts`, `lib/supabase/server.ts`
- 싱글톤 패턴 또는 팩토리 함수 사용
- 환경변수 검증 포함

[Source: lib/supabase/]

#### 보안 고려사항
- **API 키 보호**: 서버 사이드에서만 사용
- **클라이언트 노출 금지**: Gemini API는 Server Actions에서만 호출
- **토큰 제한 관리**: 8k 토큰 초과 방지

[Source: docs/architecture.md - 보안 섹션]

#### 성능 고려사항
- **타임아웃 설정**: API 호출 시 10초 타임아웃
- **에러 재시도**: 네트워크 에러 시 재시도 로직 (향후 Task에서 구현)
- **레이트 리미팅**: Gemini API 무료 할당량 고려

[Source: docs/epics/epic-4-ai-summarization-tagging.md]

#### TypeScript 타입 안전성
- 모든 API 응답에 타입 정의
- Zod 스키마 검증 고려 (선택 사항)
- 기존 프로젝트는 Zod 사용 중 (auth actions에서 확인)

[Source: app/(auth)/actions.ts - signUpSchema]

### Testing

#### 테스트 파일 위치
```
lib/gemini/__tests__/
  client.test.ts
  errors.test.ts
  test-connection.test.ts
  utils.test.ts
```

[Source: 기존 테스트 구조 패턴]

#### 테스트 프레임워크
- **Vitest**: 단위 테스트 프레임워크
- **Mocking**: `vi.mock()` 사용
- **환경변수 모킹**: `process.env` 모킹

[Source: package.json, vitest.config.ts]

#### 테스트 실행 명령어
```bash
pnpm test                 # 테스트 실행
pnpm test:ui             # UI 모드
pnpm test:run            # CI 모드 (watch 없음)
```

[Source: package.json scripts]

#### 테스트 커버리지
1. **클라이언트 초기화**
   - API 키가 있을 때 정상 초기화
   - API 키 누락 시 에러 발생
   - 모델 설정 확인

2. **에러 처리**
   - 각 에러 타입별 생성 테스트
   - parseGeminiError 함수 테스트
   - 에러 메시지 한국어 변환 테스트

3. **연결 테스트**
   - 성공 시나리오
   - 실패 시나리오 (네트워크, API 키, 타임아웃)
   - 모킹을 사용한 독립적인 테스트

4. **Mocking 전략**
   - GoogleGenAI 클래스 모킹
   - generateContent 메서드 모킹
   - 환경변수 모킹 (process.env.GEMINI_API_KEY)

#### 테스트 예시 구조
```typescript
// lib/gemini/__tests__/client.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { initGeminiClient } from '../client'

vi.mock('@google/genai', () => ({
  GoogleGenAI: vi.fn(),
}))

describe('Gemini Client', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  it('API 키가 있으면 클라이언트를 초기화한다', () => {
    process.env.GEMINI_API_KEY = 'test-key'
    // 테스트 로직
  })

  it('API 키가 없으면 에러를 발생시킨다', () => {
    delete process.env.GEMINI_API_KEY
    // 테스트 로직
  })
})
```

[Source: 기존 테스트 패턴 - app/notes/actions.test.ts, lib/errors/__tests__/auth-errors.test.ts, Context7: /googleapis/js-genai]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 최초 작성 | SM (Bob) |
| 2025-10-14 | 1.1 | 패키지명 수정: @google/generative-ai → @google/genai, 환경변수 수정: GOOGLE_GEMINI_API_KEY → GEMINI_API_KEY, 모델명 수정: gemini-2.0-flash-exp → gemini-2.0-flash (Context7 문서 참조) | SM (Bob) |
| 2025-10-14 | 2.0 | 스토리 구현 완료: 모든 Task 완료, 62개 단위 테스트 통과, 문서화 완료, Status: Ready for Review | Dev (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (Cursor IDE)

### Debug Log References

None

### Completion Notes List

1. **패키지 설치 완료**: `@google/genai v1.24.0` 설치 성공
2. **환경변수 설정 완료**: `.env.local`과 `.env.example`에 GEMINI_API_KEY 추가
3. **모든 모듈 구현 완료**: client, types, errors, utils, test-connection
4. **단위 테스트 62개 모두 통과**: 클라이언트, 에러, 유틸리티, 연결 테스트 모두 성공
5. **문서화 완료**: README에 상세한 Gemini API 설정 가이드 추가
6. **코드 품질**: 모든 파일에 JSDoc 주석 및 4줄 헤더 주석 포함
7. **타입 안전성**: TypeScript 타입 정의 완료

### File List

**생성된 파일:**
- `.env.example` - 환경변수 예시 파일 (신규 생성)
- `lib/gemini/types.ts` - TypeScript 타입 정의
- `lib/gemini/errors.ts` - 에러 핸들링 유틸리티
- `lib/gemini/client.ts` - Gemini API 클라이언트
- `lib/gemini/test-connection.ts` - API 연결 테스트 함수
- `lib/gemini/utils.ts` - 헬퍼 함수
- `lib/gemini/__tests__/client.test.ts` - 클라이언트 단위 테스트
- `lib/gemini/__tests__/errors.test.ts` - 에러 핸들링 테스트
- `lib/gemini/__tests__/utils.test.ts` - 유틸리티 테스트
- `lib/gemini/__tests__/test-connection.test.ts` - 연결 테스트

**수정된 파일:**
- `.env.local` - GEMINI_API_KEY 환경변수 추가
- `package.json` - @google/genai 의존성 추가
- `README.md` - Gemini API 설정 섹션 추가 및 프로젝트 구조 업데이트

---

## QA Results

_Not yet implemented_

