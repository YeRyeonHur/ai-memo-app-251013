# Story 2.1: 노트 생성 (제목 + 본문)

## Status

Ready for Review

---

## Story

**As a** 사용자,  
**I want** 제목과 본문을 입력하여 새로운 노트를 생성하고 싶다,  
**so that** 나의 생각과 아이디어를 빠르게 기록하고 저장할 수 있다.

---

## Acceptance Criteria

1. 사용자는 노트 생성 페이지 또는 모달에 접근할 수 있어야 한다
2. 제목(title) 입력 필드가 제공되어야 한다
   - 필수 입력 항목
   - 최대 길이 제한 (200자)
   - 실시간 글자 수 표시
3. 본문(content) 입력 필드가 제공되어야 한다
   - 필수 입력 항목
   - 멀티라인 텍스트 입력 지원
   - 충분한 높이 (최소 10줄)
4. "저장" 버튼 클릭 시 노트가 DB에 저장되어야 한다
   - 현재 인증된 사용자의 user_id와 연결
   - created_at, updated_at 자동 설정
5. 저장 성공 시 성공 메시지(toast)를 표시해야 한다
6. 저장 성공 후 노트 목록 페이지로 리다이렉트되어야 한다
7. 저장 실패 시 에러 메시지를 표시해야 한다
8. 제목 또는 본문이 비어있을 경우 유효성 검증 메시지를 표시해야 한다
9. 비인증 사용자는 노트 생성 페이지에 접근할 수 없어야 한다 (로그인 페이지로 리다이렉트)

---

## Tasks / Subtasks

- [x] Task 1: 노트 생성 UI 페이지 구현 (AC: 1, 2, 3)
  - [x] `/app/notes/new/page.tsx` 생성 (Server Component)
  - [x] 페이지 레이아웃 구성 (헤더, 폼 영역)
  - [x] 제목 입력 필드 구현 (Input 컴포넌트 사용)
    - [x] 필수 입력 표시
    - [x] 최대 길이 200자 제한
    - [x] 실시간 글자 수 카운터 표시
  - [x] 본문 입력 필드 구현 (Textarea 컴포넌트 사용)
    - [x] 멀티라인 지원
    - [x] 최소 높이 10줄
    - [x] 필수 입력 표시
  - [x] "저장" 버튼 구현 (Button 컴포넌트 사용)
  - [x] "취소" 버튼 구현 (노트 목록으로 돌아가기)

- [x] Task 2: 클라이언트 폼 컴포넌트 구현 (AC: 2, 3, 8)
  - [x] `/app/notes/new/note-form.tsx` 생성 (Client Component)
  - [x] React Hook Form 또는 기본 상태 관리로 폼 구현
  - [x] 제목 유효성 검증 (필수, 최대 길이)
  - [x] 본문 유효성 검증 (필수)
  - [x] 에러 메시지 표시 UI
  - [x] 폼 제출 시 Server Action 호출

- [x] Task 3: 노트 저장 Server Action 구현 (AC: 4, 5, 6, 7)
  - [x] `/app/notes/actions.ts` 생성 (또는 기존 파일에 추가)
  - [x] `createNote` Server Action 함수 작성
    - [x] 인증 사용자 확인 (getUser from Supabase)
    - [x] 입력 데이터 유효성 검증 (제목, 본문 필수)
    - [x] Drizzle ORM을 사용하여 notes 테이블에 삽입
      - [x] user_id, title, content 저장
      - [x] created_at, updated_at 자동 설정 (defaultNow)
    - [x] 성공 시 성공 응답 반환
    - [x] 실패 시 에러 응답 반환
  - [x] 에러 핸들링 추가 (try-catch)

- [x] Task 4: 인증 체크 및 리다이렉트 구현 (AC: 9)
  - [x] `/app/notes/new/page.tsx`에서 서버 사이드 인증 체크
  - [x] 비인증 사용자를 로그인 페이지로 리다이렉트
  - [x] middleware.ts 확인 (이미 인증 보호 설정되어 있는지 확인)

- [x] Task 5: 성공/에러 피드백 구현 (AC: 5, 7)
  - [x] Toast 알림 구현 (shadcn/ui Sonner 사용)
  - [x] 저장 성공 시 성공 메시지 표시
  - [x] 저장 실패 시 에러 메시지 표시
  - [x] 저장 성공 후 `/app/notes` 페이지로 리다이렉트

- [x] Task 6: 노트 목록 페이지 기본 구조 생성 (AC: 6)
  - [x] `/app/notes/page.tsx` 생성 (또는 기존 파일 확인)
  - [x] 노트 목록 페이지 기본 레이아웃
  - [x] "새 노트 작성" 버튼 추가 (→ /notes/new)
  - [x] 임시로 빈 상태 메시지 표시 (노트 목록 조회는 2.2 스토리에서 구현)

- [x] Task 7: 스타일링 및 UX 개선 (AC: 1, 2, 3)
  - [x] Tailwind CSS로 반응형 레이아웃 구현
  - [x] 폼 필드 간격 및 정렬 조정
  - [x] 접근성 고려 (label, aria-label)
  - [x] 로딩 상태 표시 (저장 중 버튼 비활성화)

- [x] Task 8: 테스트 작성
  - [x] `/app/notes/actions.test.ts` 생성
    - [x] createNote Server Action 유닛 테스트
    - [x] 유효성 검증 테스트
    - [x] 인증 체크 테스트
    - [x] DB 삽입 성공/실패 시나리오 테스트
  - [x] `/app/notes/new/__tests__/note-form.test.tsx` 생성
    - [x] 폼 렌더링 테스트
    - [x] 입력 필드 유효성 검증 테스트
    - [x] 폼 제출 테스트

---

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/2.0.story.md]
- Drizzle ORM 환경 세팅 완료
- notes 테이블 스키마 정의 완료 (`drizzle/schema.ts`)
- Drizzle 클라이언트 초기화 완료 (`lib/db/index.ts`)
- 마이그레이션 파일 생성 완료 (`drizzle/migrations/0000_clammy_anthem.sql`)
- **중요**: Supabase auth.users 외래키는 애플리케이션 레벨에서 검증 (호환성 문제)
- **사용자 조치 필요**: DATABASE_URL 설정 후 `pnpm db:push` 실행 필요 (마이그레이션 적용)

### 기술 스택

[Source: docs/architecture.md#1-기술-스택]
- **프레임워크**: Next.js (App Router, Server Actions)
- **UI**: shadcn/ui + Tailwind CSS + Radix UI
- **DB/인증**: Supabase (Postgres, Auth)
- **ORM**: Drizzle ORM

### 데이터 모델 (notes 테이블)

[Source: docs/architecture.md#2-데이터-모델, drizzle/schema.ts]
- **notes 테이블 스키마**:
  - `id`: UUID, primary key, 자동 생성 (defaultRandom)
  - `user_id`: UUID, not null (Supabase Auth users 참조)
  - `title`: text, not null
  - `content`: text, not null
  - `created_at`: timestamp, 기본값 now()
  - `updated_at`: timestamp, 기본값 now()
- **TypeScript 타입**: `Note`, `NewNote` (drizzle/schema.ts에서 export)

### 서버 액션

[Source: docs/architecture.md#4-서버-액션]
- `saveNote` – 노트 작성/수정 (이 스토리에서 생성 부분 구현)
- Server Actions는 `/app/notes/actions.ts`에 정의

### 보안 및 권한

[Source: docs/architecture.md#3-보안]
- **권한 스코프**: 모든 노트는 사용자 ID 스코프로 소유자만 CRUD 가능
- **인증**: Supabase Auth 사용 (`getUser`로 현재 사용자 확인)
- **클라이언트 보안**: 클라이언트에서 직접 DB 접근 금지 → Server Actions로만 접근

### 프로젝트 구조

[Source: project layout]
- **노트 관련 페이지**: `/app/notes/` 디렉토리
  - `/app/notes/page.tsx` - 노트 목록 페이지
  - `/app/notes/new/page.tsx` - 노트 생성 페이지 (이 스토리에서 생성)
- **Server Actions**: `/app/notes/actions.ts` (새로 생성)
- **UI 컴포넌트**: `/components/ui/` (shadcn/ui)

### UI 컴포넌트

[Source: project layout, 프로젝트 규칙]
- **shadcn/ui 컴포넌트 사용**:
  - `Button` (`/components/ui/button.tsx`)
  - `Input` (`/components/ui/input.tsx`)
  - `Label` (`/components/ui/label.tsx`)
  - `Card` (`/components/ui/card.tsx`)
  - `Sonner` (Toast 알림, `/components/ui/sonner.tsx`)
- **Tailwind CSS**로 스타일링

### 유효성 검증

- 제목: 필수, 최대 200자
- 본문: 필수
- 서버 사이드에서도 재검증 필수 (보안)

### 라우팅 및 리다이렉트

- 저장 성공 후 `/app/notes`로 리다이렉트 (Next.js `redirect` 함수 사용)
- 비인증 사용자는 `/login`으로 리다이렉트

### 에러 핸들링

- Server Action에서 try-catch로 에러 처리
- 클라이언트에서 에러 응답 받아 Toast로 표시

### 파일 길이 제한

[Source: 프로젝트 규칙]
- 모든 파일은 **500 LOC 이하** 유지
- 파일은 모듈화되고 단일 목적을 가져야 함

### 주석 규칙

[Source: 프로젝트 규칙]
- 모든 파일은 **4줄의 헤더 주석**으로 시작:
  1. 코드베이스 내 정확한 파일 위치
  2. 이 파일이 무엇을 하는지 설명
  3. 이 파일이 왜 존재하는지 설명
  4. 관련된 2~4개 파일 목록

---

## Testing

### 테스트 표준

[Source: 프로젝트 규칙]
- **테스트 프레임워크**: Vitest
- **테스트 파일 위치**: `__tests__/` 디렉토리 또는 동일 위치에 `.test.ts`
- **테스트 커버리지 목표**: 80% 이상

### 테스트 항목

1. **Server Action 테스트** (`/app/notes/actions.test.ts`)
   - `createNote` 함수 유닛 테스트
   - 인증된 사용자가 노트 생성 성공
   - 비인증 사용자는 노트 생성 실패
   - 제목/본문 누락 시 유효성 검증 실패
   - DB 삽입 실패 시 에러 핸들링

2. **폼 컴포넌트 테스트** (`/app/notes/new/__tests__/note-form.test.tsx`)
   - 폼이 올바르게 렌더링되는지 확인
   - 제목 입력 필드 유효성 검증 (필수, 최대 길이)
   - 본문 입력 필드 유효성 검증 (필수)
   - 폼 제출 시 Server Action 호출 확인
   - 에러 메시지 표시 확인

3. **통합 테스트** (선택적)
   - 노트 생성 플로우 E2E 테스트 (선택적, Playwright 등)

---

## Change Log

| Date       | Version | Description              | Author     |
|------------|---------|--------------------------|------------|
| 2025-10-14 | 1.0     | Story 2.1 초안 작성      | Bob (SM)   |
| 2025-10-14 | 2.0     | Story 2.1 개발 완료      | James (Dev)|

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (2025-10-14)

### Debug Log References

없음

### Completion Notes List

1. **Textarea 컴포넌트 추가**
   - shadcn/ui에서 Textarea 컴포넌트 추가 (`components/ui/textarea.tsx`)
   - 노트 본문 입력을 위한 멀티라인 텍스트 필드 지원

2. **Server Action 구현 완료**
   - `app/notes/actions.ts` 생성
   - `createNote` 함수 구현: 인증 체크, 유효성 검증, Drizzle ORM으로 DB 삽입
   - 제목 200자 제한, 제목/본문 필수 검증
   - 성공/실패 응답 구조화 (CreateNoteResult 타입)

3. **클라이언트 폼 컴포넌트 구현**
   - `app/notes/new/note-form.tsx` 생성 (Client Component)
   - useState로 폼 상태 관리, useTransition으로 로딩 처리
   - 실시간 글자 수 카운터 (200/200)
   - 클라이언트 사이드 유효성 검증
   - Toast 알림 (Sonner 사용)
   - 저장 중 버튼 비활성화 및 로딩 표시

4. **노트 생성 페이지 구현**
   - `app/notes/new/page.tsx` 생성 (Server Component)
   - 서버 사이드 인증 체크 (이중 보안)
   - 깔끔한 레이아웃 및 네비게이션

5. **노트 목록 페이지 업데이트**
   - `app/notes/page.tsx` 업데이트
   - "새 노트 작성" 버튼 추가
   - 빈 상태 UI 구현 (노트가 없을 때)
   - 헤더 및 네비게이션 개선

6. **인증 및 보안**
   - middleware.ts에서 `/notes` 경로 보호 확인 (이미 설정됨)
   - 서버 사이드 인증 체크 추가
   - 비인증 사용자 자동 리다이렉트

7. **Toast 알림 시스템**
   - Sonner Toaster는 이미 `app/layout.tsx`에 설정됨
   - 성공/실패 메시지 구현

8. **테스트 작성 및 검증**
   - `app/notes/actions.test.ts`: Server Action 유닛 테스트 (8개 테스트)
   - `app/notes/new/__tests__/note-form.test.tsx`: 폼 컴포넌트 테스트 (12개 테스트)
   - 모든 테스트 통과 (20/20 passed)
   - 유효성 검증, 인증 체크, DB 삽입, 에러 핸들링 시나리오 커버

9. **스타일링 및 UX**
   - Tailwind CSS로 반응형 레이아웃
   - 접근성 고려 (aria-label, aria-invalid, aria-describedby)
   - 에러 상태 시각화 (border-destructive)
   - 로딩 상태 표시

### File List

**Created Files:**
- `components/ui/textarea.tsx` - shadcn/ui Textarea 컴포넌트
- `app/notes/actions.ts` - 노트 관련 Server Actions
- `app/notes/new/page.tsx` - 노트 생성 페이지
- `app/notes/new/note-form.tsx` - 노트 생성 폼 컴포넌트
- `app/notes/actions.test.ts` - Server Action 테스트
- `app/notes/new/__tests__/note-form.test.tsx` - 폼 컴포넌트 테스트

**Modified Files:**
- `app/notes/page.tsx` - 노트 목록 페이지 UI 개선 및 "새 노트 작성" 버튼 추가

---

## QA Results

_(QA 에이전트가 검토 후 작성)_

