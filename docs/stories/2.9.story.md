# Story 2.9: 노트 휴지통 (Soft Delete 및 복원)

## Status

Draft

---

## Story

**As a** 사용자,  
**I want** 삭제한 노트를 휴지통에서 확인하고 필요시 복원할 수 있기를 원한다,  
**so that** 실수로 삭제한 중요한 노트를 다시 복구할 수 있다.

---

## Acceptance Criteria

1. 노트 삭제 시 실제 삭제 대신 Soft Delete로 처리되어야 한다
   - `deleted_at` 필드에 삭제 시간 저장
   - 일반 노트 목록에서는 표시되지 않음
   - 데이터베이스에는 여전히 존재

2. 휴지통 페이지(`/notes/trash`)가 존재해야 한다
   - 삭제된 노트 목록 표시
   - 삭제된 시간 표시 (예: "2일 전 삭제됨")
   - 페이지네이션 지원 (페이지당 12개)

3. 휴지통에서 노트를 복원할 수 있어야 한다
   - 각 노트 카드에 "복원" 버튼 표시
   - 복원 시 `deleted_at`을 NULL로 변경
   - 복원 성공 토스트 메시지: "노트가 복원되었습니다!"
   - 복원 후 일반 노트 목록에 다시 표시됨

4. 휴지통에서 노트를 영구 삭제할 수 있어야 한다
   - 각 노트 카드에 "영구 삭제" 버튼 표시
   - 확인 다이얼로그 표시: "정말로 영구 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다."
   - 확인 시 데이터베이스에서 완전히 삭제
   - 삭제 성공 토스트 메시지: "노트가 영구 삭제되었습니다."

5. 휴지통 비우기 기능이 있어야 한다
   - 휴지통 페이지 상단에 "휴지통 비우기" 버튼
   - 확인 다이얼로그: "휴지통의 모든 노트를 영구 삭제하시겠습니까?"
   - 확인 시 휴지통의 모든 노트 영구 삭제
   - 성공 토스트: "휴지통을 비웠습니다. (n개 삭제됨)"

6. 노트 목록 페이지에 휴지통 링크가 있어야 한다
   - 헤더 또는 사이드바에 "🗑️ 휴지통" 링크 표시
   - 휴지통에 있는 노트 개수 뱃지 표시 (선택)

7. 빈 휴지통 상태 UI가 있어야 한다
   - 삭제된 노트가 없을 때 안내 메시지 표시
   - "휴지통이 비어있습니다" 메시지
   - 노트 목록으로 돌아가기 링크

8. 데이터베이스 스키마가 Soft Delete를 지원해야 한다
   - `notes` 테이블에 `deleted_at` 컬럼 추가 (nullable timestamp)
   - 마이그레이션 파일 생성 및 적용

9. 모든 노트 조회 쿼리가 Soft Delete를 고려해야 한다
   - 일반 목록: `WHERE deleted_at IS NULL`
   - 휴지통 목록: `WHERE deleted_at IS NOT NULL`
   - 노트 상세 조회: 삭제된 노트 접근 시 404 처리

10. 권한 검증이 적용되어야 한다
    - 사용자는 자신의 삭제된 노트만 볼 수 있음
    - 다른 사용자의 휴지통 접근 불가

11. 반응형으로 구현되어야 한다
    - 모바일, 태블릿, 데스크톱에서 정상 작동

---

## Tasks / Subtasks

- [ ] Task 1: 데이터베이스 스키마 수정 (AC: 8)
  - [ ] `drizzle/schema.ts`에 `deleted_at` 컬럼 추가
  - [ ] `pnpm drizzle-kit generate` 실행하여 마이그레이션 파일 생성
  - [ ] `pnpm drizzle-kit push` 실행하여 DB에 반영
  - [ ] `deleted_at` 인덱스 추가 (성능 최적화)

- [ ] Task 2: Soft Delete Server Actions 구현 (AC: 1, 3, 4, 5)
  - [ ] `app/notes/actions.ts`에 `softDeleteNote` 함수 추가
    - [ ] 기존 `deleteNote`를 `softDeleteNote`로 변경 (deleted_at 업데이트)
  - [ ] `restoreNote` 함수 추가
    - [ ] deleted_at을 NULL로 변경
    - [ ] 권한 검증 (현재 사용자의 노트만)
  - [ ] `permanentlyDeleteNote` 함수 추가
    - [ ] 데이터베이스에서 완전히 삭제
    - [ ] 권한 검증
  - [ ] `emptyTrash` 함수 추가
    - [ ] 현재 사용자의 모든 삭제된 노트 영구 삭제
  - [ ] `getDeletedNotes` 함수 추가
    - [ ] WHERE deleted_at IS NOT NULL
    - [ ] 페이지네이션 지원 (12개씩)
    - [ ] 최신 삭제순 정렬

- [ ] Task 3: 기존 노트 조회 쿼리 수정 (AC: 9)
  - [ ] `getNotes` 함수 수정
    - [ ] WHERE deleted_at IS NULL 조건 추가
  - [ ] `getNoteById` 함수 수정
    - [ ] 삭제된 노트 조회 시 에러 반환
  - [ ] `updateNote` 함수 수정
    - [ ] 삭제된 노트 수정 방지

- [ ] Task 4: 휴지통 페이지 구현 (AC: 2, 6, 7)
  - [ ] `app/notes/trash/page.tsx` 생성 (Server Component)
  - [ ] 삭제된 노트 목록 조회 및 표시
  - [ ] 페이지네이션 컴포넌트 재사용
  - [ ] 빈 휴지통 상태 UI
  - [ ] "노트 목록으로 돌아가기" 링크

- [ ] Task 5: 휴지통 노트 카드 컴포넌트 (AC: 3, 4)
  - [ ] `app/notes/trash/trash-note-card.tsx` 생성 (Client Component)
  - [ ] 노트 제목, 내용 미리보기, 삭제 시간 표시
  - [ ] "복원" 버튼 (restoreNote 호출)
  - [ ] "영구 삭제" 버튼 (permanentlyDeleteNote 호출)
  - [ ] 버튼 로딩 상태 처리
  - [ ] 토스트 메시지 표시

- [ ] Task 6: 영구 삭제 확인 다이얼로그 (AC: 4)
  - [ ] `app/notes/trash/permanent-delete-dialog.tsx` 생성
  - [ ] shadcn/ui AlertDialog 사용
  - [ ] 경고 메시지 및 확인/취소 버튼
  - [ ] 삭제 중 로딩 상태

- [ ] Task 7: 휴지통 비우기 기능 (AC: 5)
  - [ ] `app/notes/trash/empty-trash-button.tsx` 생성
  - [ ] 확인 다이얼로그
  - [ ] emptyTrash Server Action 호출
  - [ ] 성공 시 페이지 리프레시

- [ ] Task 8: 노트 목록 페이지에 휴지통 링크 추가 (AC: 6)
  - [ ] `app/notes/page.tsx` 수정
  - [ ] 헤더에 "🗑️ 휴지통" 링크 추가
  - [ ] (선택) 삭제된 노트 개수 뱃지

- [ ] Task 9: 기존 삭제 기능 업데이트
  - [ ] 노트 상세 페이지의 삭제 기능을 Soft Delete로 변경
  - [ ] 삭제 확인 다이얼로그 메시지 수정
    - [ ] "노트가 휴지통으로 이동되었습니다"
  - [ ] 삭제 후 노트 목록으로 리다이렉트

- [ ] Task 10: 스타일링 및 UX 개선 (AC: 11)
  - [ ] 휴지통 페이지 레이아웃 (노트 목록과 일관성)
  - [ ] 삭제 시간 표시 포맷 (date-fns 사용)
  - [ ] 모바일 반응형 테스트
  - [ ] 접근성 고려 (aria-label, role)

- [ ] Task 11: 테스트 작성
  - [ ] `app/notes/trash/actions.test.ts` 생성
    - [ ] softDeleteNote 테스트
    - [ ] restoreNote 테스트
    - [ ] permanentlyDeleteNote 테스트
    - [ ] emptyTrash 테스트
    - [ ] getDeletedNotes 테스트
  - [ ] 수동 E2E 테스트
    - [ ] 노트 삭제 → 휴지통 확인
    - [ ] 노트 복원 → 목록에 다시 표시
    - [ ] 영구 삭제 → 완전히 사라짐
    - [ ] 휴지통 비우기

---

## Dev Notes

### 기술 스택 및 아키텍처 정보

#### Soft Delete 패턴
- **deleted_at 컬럼**: nullable timestamp, 삭제 시간 저장
- **장점**:
  - 실수로 삭제한 데이터 복구 가능
  - 데이터 감사 추적 (audit trail)
  - 삭제 통계 수집 가능
- **단점**:
  - 쿼리가 복잡해짐 (모든 조회에 WHERE 조건 추가)
  - 스토리지 사용량 증가

#### 데이터베이스 마이그레이션
```typescript
// drizzle/schema.ts에 추가
export const notes = pgTable(
  'notes',
  {
    // ... 기존 컬럼들
    deletedAt: timestamp('deleted_at', { withTimezone: true }),
  },
  (table) => ({
    // ... 기존 인덱스들
    deletedAtIdx: index('notes_deleted_at_idx').on(table.deletedAt),
  })
);
```

#### 관련 파일
- `drizzle/schema.ts`: 스키마 정의 수정
- `app/notes/actions.ts`: Server Actions 추가/수정
- `app/notes/trash/page.tsx`: 휴지통 페이지 (신규)
- `app/notes/trash/trash-note-card.tsx`: 휴지통 노트 카드 (신규)
- `app/notes/page.tsx`: 휴지통 링크 추가

#### Soft Delete 쿼리 패턴
```typescript
// 일반 노트 조회
const activeNotes = await db
  .select()
  .from(notes)
  .where(and(
    eq(notes.userId, user.id),
    isNull(notes.deletedAt)  // 삭제되지 않은 노트만
  ))

// 삭제된 노트 조회 (휴지통)
const deletedNotes = await db
  .select()
  .from(notes)
  .where(and(
    eq(notes.userId, user.id),
    isNotNull(notes.deletedAt)  // 삭제된 노트만
  ))

// Soft Delete
await db
  .update(notes)
  .set({ deletedAt: new Date() })
  .where(eq(notes.id, noteId))

// 복원
await db
  .update(notes)
  .set({ deletedAt: null })
  .where(eq(notes.id, noteId))

// 영구 삭제
await db
  .delete(notes)
  .where(eq(notes.id, noteId))
```

#### UI/UX 고려사항
1. **명확한 피드백**: 삭제 시 "휴지통으로 이동됨" 메시지
2. **복원 용이성**: 휴지통에서 쉽게 복원 가능
3. **영구 삭제 경고**: 되돌릴 수 없다는 명확한 경고
4. **삭제 시간 표시**: 언제 삭제되었는지 표시
5. **빈 상태 처리**: 휴지통이 비었을 때 안내 메시지

#### 선택적 기능 (향후 고려)
- 자동 삭제: 30일 후 자동 영구 삭제
- 삭제 전 알림: "7일 후 영구 삭제됩니다" 경고
- 일괄 복원: 여러 노트를 한 번에 복원
- 검색: 휴지통에서도 검색 가능

### Testing

#### 테스트 파일 위치
- Server Actions: `app/notes/trash/__tests__/actions.test.ts`
- 컴포넌트: `app/notes/trash/__tests__/trash-note-card.test.tsx`

#### 테스트 프레임워크
- **Vitest**: 단위/통합 테스트
- **@testing-library/react**: React 컴포넌트 테스트

#### 테스트 커버리지
1. **Soft Delete**
   - 노트 삭제 시 deleted_at 업데이트 확인
   - 일반 목록에서 삭제된 노트가 표시되지 않는지 확인
2. **복원**
   - 복원 시 deleted_at이 NULL로 변경되는지 확인
   - 복원 후 일반 목록에 다시 표시되는지 확인
3. **영구 삭제**
   - 데이터베이스에서 완전히 삭제되는지 확인
4. **휴지통 비우기**
   - 모든 삭제된 노트가 영구 삭제되는지 확인
5. **권한 검증**
   - 다른 사용자의 삭제된 노트에 접근 시 에러 발생 확인

#### 테스트 실행
```bash
pnpm test
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 최초 작성 | PO (Sarah) |

---

## Dev Agent Record

### Agent Model Used

_Not yet assigned_

### Debug Log References

None

### Completion Notes List

_Not yet implemented_

### File List

_Not yet implemented_

---

## QA Results

_Not yet implemented_

