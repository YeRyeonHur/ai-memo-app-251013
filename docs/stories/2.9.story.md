# Story 2.9: λ…ΈνΈ ν΄μ§€ν†µ (Soft Delete λ° λ³µμ›)

## Status

Draft

---

## Story

**As a** μ‚¬μ©μ,  
**I want** μ‚­μ ν• λ…ΈνΈλ¥Ό ν΄μ§€ν†µμ—μ„ ν™•μΈν•κ³  ν•„μ”μ‹ λ³µμ›ν•  μ μκΈ°λ¥Ό μ›ν•λ‹¤,  
**so that** μ‹¤μλ΅ μ‚­μ ν• μ¤‘μ”ν• λ…ΈνΈλ¥Ό λ‹¤μ‹ λ³µκµ¬ν•  μ μλ‹¤.

---

## Acceptance Criteria

1. λ…ΈνΈ μ‚­μ  μ‹ μ‹¤μ  μ‚­μ  λ€μ‹  Soft Deleteλ΅ μ²λ¦¬λμ–΄μ•Ό ν•λ‹¤
   - `deleted_at` ν•„λ“μ— μ‚­μ  μ‹κ°„ μ €μ¥
   - μΌλ° λ…ΈνΈ λ©λ΅μ—μ„λ” ν‘μ‹λμ§€ μ•μ
   - λ°μ΄ν„°λ² μ΄μ¤μ—λ” μ—¬μ „ν μ΅΄μ¬

2. ν΄μ§€ν†µ νμ΄μ§€(`/notes/trash`)κ°€ μ΅΄μ¬ν•΄μ•Ό ν•λ‹¤
   - μ‚­μ λ λ…ΈνΈ λ©λ΅ ν‘μ‹
   - μ‚­μ λ μ‹κ°„ ν‘μ‹ (μ: "2μΌ μ „ μ‚­μ λ¨")
   - νμ΄μ§€λ„¤μ΄μ… μ§€μ› (νμ΄μ§€λ‹Ή 12κ°)

3. ν΄μ§€ν†µμ—μ„ λ…ΈνΈλ¥Ό λ³µμ›ν•  μ μμ–΄μ•Ό ν•λ‹¤
   - κ° λ…ΈνΈ μΉ΄λ“μ— "λ³µμ›" λ²„νΌ ν‘μ‹
   - λ³µμ› μ‹ `deleted_at`μ„ NULLλ΅ λ³€κ²½
   - λ³µμ› μ„±κ³µ ν† μ¤νΈ λ©”μ‹μ§€: "λ…ΈνΈκ°€ λ³µμ›λμ—μµλ‹λ‹¤!"
   - λ³µμ› ν›„ μΌλ° λ…ΈνΈ λ©λ΅μ— λ‹¤μ‹ ν‘μ‹λ¨

4. ν΄μ§€ν†µμ—μ„ λ…ΈνΈλ¥Ό μκµ¬ μ‚­μ ν•  μ μμ–΄μ•Ό ν•λ‹¤
   - κ° λ…ΈνΈ μΉ΄λ“μ— "μκµ¬ μ‚­μ " λ²„νΌ ν‘μ‹
   - ν™•μΈ λ‹¤μ΄μ–Όλ΅κ·Έ ν‘μ‹: "μ •λ§λ΅ μκµ¬ μ‚­μ ν•μ‹κ² μµλ‹κΉ? μ΄ μ‘μ—…μ€ λλλ¦΄ μ μ—†μµλ‹λ‹¤."
   - ν™•μΈ μ‹ λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ™„μ „ν μ‚­μ 
   - μ‚­μ  μ„±κ³µ ν† μ¤νΈ λ©”μ‹μ§€: "λ…ΈνΈκ°€ μκµ¬ μ‚­μ λμ—μµλ‹λ‹¤."

5. ν΄μ§€ν†µ λΉ„μ°κΈ° κΈ°λ¥μ΄ μμ–΄μ•Ό ν•λ‹¤
   - ν΄μ§€ν†µ νμ΄μ§€ μƒλ‹¨μ— "ν΄μ§€ν†µ λΉ„μ°κΈ°" λ²„νΌ
   - ν™•μΈ λ‹¤μ΄μ–Όλ΅κ·Έ: "ν΄μ§€ν†µμ λ¨λ“  λ…ΈνΈλ¥Ό μκµ¬ μ‚­μ ν•μ‹κ² μµλ‹κΉ?"
   - ν™•μΈ μ‹ ν΄μ§€ν†µμ λ¨λ“  λ…ΈνΈ μκµ¬ μ‚­μ 
   - μ„±κ³µ ν† μ¤νΈ: "ν΄μ§€ν†µμ„ λΉ„μ› μµλ‹λ‹¤. (nκ° μ‚­μ λ¨)"

6. λ…ΈνΈ λ©λ΅ νμ΄μ§€μ— ν΄μ§€ν†µ λ§ν¬κ°€ μμ–΄μ•Ό ν•λ‹¤
   - ν—¤λ” λλ” μ‚¬μ΄λ“λ°”μ— "π—‘οΈ ν΄μ§€ν†µ" λ§ν¬ ν‘μ‹
   - ν΄μ§€ν†µμ— μλ” λ…ΈνΈ κ°μ λ±ƒμ§€ ν‘μ‹ (μ„ νƒ)

7. λΉ ν΄μ§€ν†µ μƒνƒ UIκ°€ μμ–΄μ•Ό ν•λ‹¤
   - μ‚­μ λ λ…ΈνΈκ°€ μ—†μ„ λ• μ•λ‚΄ λ©”μ‹μ§€ ν‘μ‹
   - "ν΄μ§€ν†µμ΄ λΉ„μ–΄μμµλ‹λ‹¤" λ©”μ‹μ§€
   - λ…ΈνΈ λ©λ΅μΌλ΅ λμ•„κ°€κΈ° λ§ν¬

8. λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§κ°€ Soft Deleteλ¥Ό μ§€μ›ν•΄μ•Ό ν•λ‹¤
   - `notes` ν…μ΄λΈ”μ— `deleted_at` μ»¬λΌ μ¶”κ°€ (nullable timestamp)
   - λ§μ΄κ·Έλ μ΄μ… νμΌ μƒμ„± λ° μ μ©

9. λ¨λ“  λ…ΈνΈ μ΅°ν μΏΌλ¦¬κ°€ Soft Deleteλ¥Ό κ³ λ ¤ν•΄μ•Ό ν•λ‹¤
   - μΌλ° λ©λ΅: `WHERE deleted_at IS NULL`
   - ν΄μ§€ν†µ λ©λ΅: `WHERE deleted_at IS NOT NULL`
   - λ…ΈνΈ μƒμ„Έ μ΅°ν: μ‚­μ λ λ…ΈνΈ μ ‘κ·Ό μ‹ 404 μ²λ¦¬

10. κ¶ν• κ²€μ¦μ΄ μ μ©λμ–΄μ•Ό ν•λ‹¤
    - μ‚¬μ©μλ” μμ‹ μ μ‚­μ λ λ…ΈνΈλ§ λ³Ό μ μμ
    - λ‹¤λ¥Έ μ‚¬μ©μμ ν΄μ§€ν†µ μ ‘κ·Ό λ¶κ°€

11. λ°μ‘ν•μΌλ΅ κµ¬ν„λμ–΄μ•Ό ν•λ‹¤
    - λ¨λ°”μΌ, νƒλΈ”λ¦Ώ, λ°μ¤ν¬ν†±μ—μ„ μ •μƒ μ‘λ™

---

## Tasks / Subtasks

- [ ] Task 1: λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§ μμ • (AC: 8)
  - [ ] `drizzle/schema.ts`μ— `deleted_at` μ»¬λΌ μ¶”κ°€
  - [ ] `pnpm drizzle-kit generate` μ‹¤ν–‰ν•μ—¬ λ§μ΄κ·Έλ μ΄μ… νμΌ μƒμ„±
  - [ ] `pnpm drizzle-kit push` μ‹¤ν–‰ν•μ—¬ DBμ— λ°μ
  - [ ] `deleted_at` μΈλ±μ¤ μ¶”κ°€ (μ„±λ¥ μµμ ν™”)

- [ ] Task 2: Soft Delete Server Actions κµ¬ν„ (AC: 1, 3, 4, 5)
  - [ ] `app/notes/actions.ts`μ— `softDeleteNote` ν•¨μ μ¶”κ°€
    - [ ] κΈ°μ΅΄ `deleteNote`λ¥Ό `softDeleteNote`λ΅ λ³€κ²½ (deleted_at μ—…λ°μ΄νΈ)
  - [ ] `restoreNote` ν•¨μ μ¶”κ°€
    - [ ] deleted_atμ„ NULLλ΅ λ³€κ²½
    - [ ] κ¶ν• κ²€μ¦ (ν„μ¬ μ‚¬μ©μμ λ…ΈνΈλ§)
  - [ ] `permanentlyDeleteNote` ν•¨μ μ¶”κ°€
    - [ ] λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ™„μ „ν μ‚­μ 
    - [ ] κ¶ν• κ²€μ¦
  - [ ] `emptyTrash` ν•¨μ μ¶”κ°€
    - [ ] ν„μ¬ μ‚¬μ©μμ λ¨λ“  μ‚­μ λ λ…ΈνΈ μκµ¬ μ‚­μ 
  - [ ] `getDeletedNotes` ν•¨μ μ¶”κ°€
    - [ ] WHERE deleted_at IS NOT NULL
    - [ ] νμ΄μ§€λ„¤μ΄μ… μ§€μ› (12κ°μ”©)
    - [ ] μµμ‹  μ‚­μ μ μ •λ ¬

- [ ] Task 3: κΈ°μ΅΄ λ…ΈνΈ μ΅°ν μΏΌλ¦¬ μμ • (AC: 9)
  - [ ] `getNotes` ν•¨μ μμ •
    - [ ] WHERE deleted_at IS NULL μ΅°κ±΄ μ¶”κ°€
  - [ ] `getNoteById` ν•¨μ μμ •
    - [ ] μ‚­μ λ λ…ΈνΈ μ΅°ν μ‹ μ—λ¬ λ°ν™
  - [ ] `updateNote` ν•¨μ μμ •
    - [ ] μ‚­μ λ λ…ΈνΈ μμ • λ°©μ§€

- [ ] Task 4: ν΄μ§€ν†µ νμ΄μ§€ κµ¬ν„ (AC: 2, 6, 7)
  - [ ] `app/notes/trash/page.tsx` μƒμ„± (Server Component)
  - [ ] μ‚­μ λ λ…ΈνΈ λ©λ΅ μ΅°ν λ° ν‘μ‹
  - [ ] νμ΄μ§€λ„¤μ΄μ… μ»΄ν¬λ„νΈ μ¬μ‚¬μ©
  - [ ] λΉ ν΄μ§€ν†µ μƒνƒ UI
  - [ ] "λ…ΈνΈ λ©λ΅μΌλ΅ λμ•„κ°€κΈ°" λ§ν¬

- [ ] Task 5: ν΄μ§€ν†µ λ…ΈνΈ μΉ΄λ“ μ»΄ν¬λ„νΈ (AC: 3, 4)
  - [ ] `app/notes/trash/trash-note-card.tsx` μƒμ„± (Client Component)
  - [ ] λ…ΈνΈ μ λ©, λ‚΄μ© λ―Έλ¦¬λ³΄κΈ°, μ‚­μ  μ‹κ°„ ν‘μ‹
  - [ ] "λ³µμ›" λ²„νΌ (restoreNote νΈμ¶)
  - [ ] "μκµ¬ μ‚­μ " λ²„νΌ (permanentlyDeleteNote νΈμ¶)
  - [ ] λ²„νΌ λ΅λ”© μƒνƒ μ²λ¦¬
  - [ ] ν† μ¤νΈ λ©”μ‹μ§€ ν‘μ‹

- [ ] Task 6: μκµ¬ μ‚­μ  ν™•μΈ λ‹¤μ΄μ–Όλ΅κ·Έ (AC: 4)
  - [ ] `app/notes/trash/permanent-delete-dialog.tsx` μƒμ„±
  - [ ] shadcn/ui AlertDialog μ‚¬μ©
  - [ ] κ²½κ³  λ©”μ‹μ§€ λ° ν™•μΈ/μ·¨μ† λ²„νΌ
  - [ ] μ‚­μ  μ¤‘ λ΅λ”© μƒνƒ

- [ ] Task 7: ν΄μ§€ν†µ λΉ„μ°κΈ° κΈ°λ¥ (AC: 5)
  - [ ] `app/notes/trash/empty-trash-button.tsx` μƒμ„±
  - [ ] ν™•μΈ λ‹¤μ΄μ–Όλ΅κ·Έ
  - [ ] emptyTrash Server Action νΈμ¶
  - [ ] μ„±κ³µ μ‹ νμ΄μ§€ λ¦¬ν”„λ μ‹

- [ ] Task 8: λ…ΈνΈ λ©λ΅ νμ΄μ§€μ— ν΄μ§€ν†µ λ§ν¬ μ¶”κ°€ (AC: 6)
  - [ ] `app/notes/page.tsx` μμ •
  - [ ] ν—¤λ”μ— "π—‘οΈ ν΄μ§€ν†µ" λ§ν¬ μ¶”κ°€
  - [ ] (μ„ νƒ) μ‚­μ λ λ…ΈνΈ κ°μ λ±ƒμ§€

- [ ] Task 9: κΈ°μ΅΄ μ‚­μ  κΈ°λ¥ μ—…λ°μ΄νΈ
  - [ ] λ…ΈνΈ μƒμ„Έ νμ΄μ§€μ μ‚­μ  κΈ°λ¥μ„ Soft Deleteλ΅ λ³€κ²½
  - [ ] μ‚­μ  ν™•μΈ λ‹¤μ΄μ–Όλ΅κ·Έ λ©”μ‹μ§€ μμ •
    - [ ] "λ…ΈνΈκ°€ ν΄μ§€ν†µμΌλ΅ μ΄λ™λμ—μµλ‹λ‹¤"
  - [ ] μ‚­μ  ν›„ λ…ΈνΈ λ©λ΅μΌλ΅ λ¦¬λ‹¤μ΄λ ‰νΈ

- [ ] Task 10: μ¤νƒ€μΌλ§ λ° UX κ°μ„  (AC: 11)
  - [ ] ν΄μ§€ν†µ νμ΄μ§€ λ μ΄μ•„μ›ƒ (λ…ΈνΈ λ©λ΅κ³Ό μΌκ΄€μ„±)
  - [ ] μ‚­μ  μ‹κ°„ ν‘μ‹ ν¬λ§· (date-fns μ‚¬μ©)
  - [ ] λ¨λ°”μΌ λ°μ‘ν• ν…μ¤νΈ
  - [ ] μ ‘κ·Όμ„± κ³ λ ¤ (aria-label, role)

- [ ] Task 11: ν…μ¤νΈ μ‘μ„±
  - [ ] `app/notes/trash/actions.test.ts` μƒμ„±
    - [ ] softDeleteNote ν…μ¤νΈ
    - [ ] restoreNote ν…μ¤νΈ
    - [ ] permanentlyDeleteNote ν…μ¤νΈ
    - [ ] emptyTrash ν…μ¤νΈ
    - [ ] getDeletedNotes ν…μ¤νΈ
  - [ ] μλ™ E2E ν…μ¤νΈ
    - [ ] λ…ΈνΈ μ‚­μ  β†’ ν΄μ§€ν†µ ν™•μΈ
    - [ ] λ…ΈνΈ λ³µμ› β†’ λ©λ΅μ— λ‹¤μ‹ ν‘μ‹
    - [ ] μκµ¬ μ‚­μ  β†’ μ™„μ „ν μ‚¬λΌμ§
    - [ ] ν΄μ§€ν†µ λΉ„μ°κΈ°

---

## Dev Notes

### κΈ°μ  μ¤νƒ λ° μ•„ν‚¤ν…μ² μ •λ³΄

#### Soft Delete ν¨ν„΄
- **deleted_at μ»¬λΌ**: nullable timestamp, μ‚­μ  μ‹κ°„ μ €μ¥
- **μ¥μ **:
  - μ‹¤μλ΅ μ‚­μ ν• λ°μ΄ν„° λ³µκµ¬ κ°€λ¥
  - λ°μ΄ν„° κ°μ‚¬ μ¶”μ  (audit trail)
  - μ‚­μ  ν†µκ³„ μμ§‘ κ°€λ¥
- **λ‹¨μ **:
  - μΏΌλ¦¬κ°€ λ³µμ΅ν•΄μ§ (λ¨λ“  μ΅°νμ— WHERE μ΅°κ±΄ μ¶”κ°€)
  - μ¤ν† λ¦¬μ§€ μ‚¬μ©λ‰ μ¦κ°€

#### λ°μ΄ν„°λ² μ΄μ¤ λ§μ΄κ·Έλ μ΄μ…
```typescript
// drizzle/schema.tsμ— μ¶”κ°€
export const notes = pgTable(
  'notes',
  {
    // ... κΈ°μ΅΄ μ»¬λΌλ“¤
    deletedAt: timestamp('deleted_at', { withTimezone: true }),
  },
  (table) => ({
    // ... κΈ°μ΅΄ μΈλ±μ¤λ“¤
    deletedAtIdx: index('notes_deleted_at_idx').on(table.deletedAt),
  })
);
```

#### κ΄€λ ¨ νμΌ
- `drizzle/schema.ts`: μ¤ν‚¤λ§ μ •μ μμ •
- `app/notes/actions.ts`: Server Actions μ¶”κ°€/μμ •
- `app/notes/trash/page.tsx`: ν΄μ§€ν†µ νμ΄μ§€ (μ‹ κ·)
- `app/notes/trash/trash-note-card.tsx`: ν΄μ§€ν†µ λ…ΈνΈ μΉ΄λ“ (μ‹ κ·)
- `app/notes/page.tsx`: ν΄μ§€ν†µ λ§ν¬ μ¶”κ°€

#### Soft Delete μΏΌλ¦¬ ν¨ν„΄
```typescript
// μΌλ° λ…ΈνΈ μ΅°ν
const activeNotes = await db
  .select()
  .from(notes)
  .where(and(
    eq(notes.userId, user.id),
    isNull(notes.deletedAt)  // μ‚­μ λμ§€ μ•μ€ λ…ΈνΈλ§
  ))

// μ‚­μ λ λ…ΈνΈ μ΅°ν (ν΄μ§€ν†µ)
const deletedNotes = await db
  .select()
  .from(notes)
  .where(and(
    eq(notes.userId, user.id),
    isNotNull(notes.deletedAt)  // μ‚­μ λ λ…ΈνΈλ§
  ))

// Soft Delete
await db
  .update(notes)
  .set({ deletedAt: new Date() })
  .where(eq(notes.id, noteId))

// λ³µμ›
await db
  .update(notes)
  .set({ deletedAt: null })
  .where(eq(notes.id, noteId))

// μκµ¬ μ‚­μ 
await db
  .delete(notes)
  .where(eq(notes.id, noteId))
```

#### UI/UX κ³ λ ¤μ‚¬ν•­
1. **λ…ν™•ν• ν”Όλ“λ°±**: μ‚­μ  μ‹ "ν΄μ§€ν†µμΌλ΅ μ΄λ™λ¨" λ©”μ‹μ§€
2. **λ³µμ› μ©μ΄μ„±**: ν΄μ§€ν†µμ—μ„ μ‰½κ² λ³µμ› κ°€λ¥
3. **μκµ¬ μ‚­μ  κ²½κ³ **: λλλ¦΄ μ μ—†λ‹¤λ” λ…ν™•ν• κ²½κ³ 
4. **μ‚­μ  μ‹κ°„ ν‘μ‹**: μ–Έμ  μ‚­μ λμ—λ”μ§€ ν‘μ‹
5. **λΉ μƒνƒ μ²λ¦¬**: ν΄μ§€ν†µμ΄ λΉ„μ—μ„ λ• μ•λ‚΄ λ©”μ‹μ§€

#### μ„ νƒμ  κΈ°λ¥ (ν–¥ν›„ κ³ λ ¤)
- μλ™ μ‚­μ : 30μΌ ν›„ μλ™ μκµ¬ μ‚­μ 
- μ‚­μ  μ „ μ•λ¦Ό: "7μΌ ν›„ μκµ¬ μ‚­μ λ©λ‹λ‹¤" κ²½κ³ 
- μΌκ΄„ λ³µμ›: μ—¬λ¬ λ…ΈνΈλ¥Ό ν• λ²μ— λ³µμ›
- κ²€μƒ‰: ν΄μ§€ν†µμ—μ„λ„ κ²€μƒ‰ κ°€λ¥

### Testing

#### ν…μ¤νΈ νμΌ μ„μΉ
- Server Actions: `app/notes/trash/__tests__/actions.test.ts`
- μ»΄ν¬λ„νΈ: `app/notes/trash/__tests__/trash-note-card.test.tsx`

#### ν…μ¤νΈ ν”„λ μ„μ›ν¬
- **Vitest**: λ‹¨μ„/ν†µν•© ν…μ¤νΈ
- **@testing-library/react**: React μ»΄ν¬λ„νΈ ν…μ¤νΈ

#### ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€
1. **Soft Delete**
   - λ…ΈνΈ μ‚­μ  μ‹ deleted_at μ—…λ°μ΄νΈ ν™•μΈ
   - μΌλ° λ©λ΅μ—μ„ μ‚­μ λ λ…ΈνΈκ°€ ν‘μ‹λμ§€ μ•λ”μ§€ ν™•μΈ
2. **λ³µμ›**
   - λ³µμ› μ‹ deleted_atμ΄ NULLλ΅ λ³€κ²½λλ”μ§€ ν™•μΈ
   - λ³µμ› ν›„ μΌλ° λ©λ΅μ— λ‹¤μ‹ ν‘μ‹λλ”μ§€ ν™•μΈ
3. **μκµ¬ μ‚­μ **
   - λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ™„μ „ν μ‚­μ λλ”μ§€ ν™•μΈ
4. **ν΄μ§€ν†µ λΉ„μ°κΈ°**
   - λ¨λ“  μ‚­μ λ λ…ΈνΈκ°€ μκµ¬ μ‚­μ λλ”μ§€ ν™•μΈ
5. **κ¶ν• κ²€μ¦**
   - λ‹¤λ¥Έ μ‚¬μ©μμ μ‚­μ λ λ…ΈνΈμ— μ ‘κ·Ό μ‹ μ—λ¬ λ°μƒ ν™•μΈ

#### ν…μ¤νΈ μ‹¤ν–‰
```bash
pnpm test
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | μ¤ν† λ¦¬ μµμ΄ μ‘μ„± | PO (Sarah) |

---

## Dev Agent Record

### Agent Model Used

_Not yet assigned_

### Debug Log References

None

### Completion Notes List

_Not yet implemented_

### File List

_Not yet implemented_

---

## QA Results

_Not yet implemented_

