# Story 2.5: 노트 삭제

## Status

Ready for Review

---

## Story

**As a** 사용자,  
**I want** 불필요한 노트를 삭제하고 싶다,  
**so that** 노트 목록을 깔끔하게 유지하고 필요한 노트에만 집중할 수 있다.

---

## Acceptance Criteria

1. 노트 상세 페이지에서 "삭제" 버튼 클릭 시 확인 다이얼로그가 표시되어야 한다
   - "정말 이 노트를 삭제하시겠습니까?" 메시지
   - "취소"와 "삭제" 버튼
2. 확인 다이얼로그에서 "삭제" 버튼 클릭 시
   - 노트가 데이터베이스에서 영구 삭제되어야 한다
   - 노트 목록 페이지로 리다이렉트되어야 한다
   - "노트가 삭제되었습니다" 성공 메시지 표시
3. 확인 다이얼로그에서 "취소" 버튼 클릭 시
   - 다이얼로그가 닫히고 노트 상세 페이지에 그대로 남아있어야 한다
4. 비인증 사용자는 노트를 삭제할 수 없어야 한다
   - 인증 실패 시 에러 메시지 반환
5. 다른 사용자의 노트는 삭제할 수 없어야 한다
   - 권한이 없는 경우 에러 메시지 반환
6. 삭제 작업 중에는 버튼이 비활성화되어야 한다
   - "삭제 중..." 로딩 표시
7. 삭제 실패 시 에러 메시지를 표시해야 한다
   - 네트워크 오류, DB 오류 등
8. 노트 목록에서도 개별 노트 삭제가 가능해야 한다 (선택적)
   - 노트 카드에 삭제 아이콘 버튼
9. 삭제된 노트는 즉시 목록에서 제거되어야 한다
   - revalidatePath로 캐시 무효화
10. 반응형으로 구현되어야 한다
    - 모바일에서도 사용하기 쉬운 다이얼로그

---

## Tasks / Subtasks

- [ ] Task 1: 노트 삭제 Server Action 구현 (AC: 2, 4, 5, 7, 9)
  - [ ] `/app/notes/actions.ts`에 `deleteNote` 함수 추가
  - [ ] 인증 사용자 확인 (getUser)
  - [ ] Drizzle ORM으로 노트 삭제
    - [ ] id와 user_id로 필터링 (소유자만 삭제 가능)
    - [ ] DELETE 쿼리 실행
    - [ ] 삭제된 행 수 확인
  - [ ] 성공/실패 응답 반환
  - [ ] 타입 정의 (DeleteNoteResult)
  - [ ] revalidatePath로 캐시 무효화

- [ ] Task 2: 삭제 확인 다이얼로그 컴포넌트 구현 (AC: 1, 3)
  - [ ] shadcn/ui `AlertDialog` 컴포넌트 설치
  - [ ] `/app/notes/[id]/delete-dialog.tsx` 생성 (Client Component)
  - [ ] 확인 메시지 표시
  - [ ] "취소", "삭제" 버튼
  - [ ] 열림/닫힘 상태 관리
  - [ ] 삭제 액션 트리거

- [ ] Task 3: 노트 상세 페이지에 삭제 기능 통합 (AC: 2, 6)
  - [ ] `/app/notes/[id]/page.tsx` 수정
  - [ ] "삭제" 버튼 활성화 (현재 disabled 제거)
  - [ ] DeleteDialog 컴포넌트 추가
  - [ ] 삭제 버튼 클릭 시 다이얼로그 열기
  - [ ] 삭제 성공 시 `/notes`로 리다이렉트
  - [ ] 로딩 상태 관리

- [ ] Task 4: 에러 처리 및 사용자 피드백 (AC: 6, 7)
  - [ ] 삭제 중 로딩 표시
  - [ ] 삭제 성공 시 Toast 메시지
  - [ ] 삭제 실패 시 Toast 에러 메시지
  - [ ] 버튼 비활성화/활성화 로직

- [ ] Task 5: 노트 카드에서 삭제 기능 (AC: 8) - 선택적
  - [ ] `/app/notes/note-card.tsx` 수정
  - [ ] 삭제 아이콘 버튼 추가
  - [ ] 호버 시 표시
  - [ ] 클릭 시 확인 다이얼로그

- [ ] Task 6: 테스트 작성
  - [ ] `/app/notes/actions.test.ts`에 deleteNote 테스트 추가
    - [ ] 인증 사용자가 자신의 노트 삭제 성공
    - [ ] 다른 사용자의 노트 삭제 실패
    - [ ] 존재하지 않는 노트 삭제 시 에러 처리
    - [ ] 비인증 사용자는 삭제 실패
  - [ ] 컴포넌트 테스트 (선택적)
    - [ ] 다이얼로그 렌더링 테스트
    - [ ] 삭제 확인 플로우 테스트

---

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/2.3.story.md]
- 노트 상세 페이지 구현 완료
- "삭제" 버튼이 현재 disabled 상태로 구현됨
- getNoteById Server Action 구현 완료

[Source: docs/stories/2.4.story.md]
- updateNote Server Action 구현 완료
- Server Action 패턴 정립 완료 (인증, 권한, 에러 처리)

### 기술 스택

[Source: docs/architecture.md#1-기술-스택]
- **프레임워크**: Next.js (App Router, Server Actions)
- **UI**: shadcn/ui + Tailwind CSS + Radix UI
- **DB/인증**: Supabase (Postgres, Auth)
- **ORM**: Drizzle ORM

### 데이터 모델 (notes 테이블)

[Source: drizzle/schema.ts]
- **notes 테이블 스키마**:
  - `id`: UUID, primary key
  - `user_id`: UUID, not null
  - `title`: text, not null
  - `content`: text, not null
  - `created_at`: timestamp, 기본값 now()
  - `updated_at`: timestamp, 기본값 now()

### 서버 액션

[Source: docs/architecture.md#4-서버-액션]
- `deleteNote` – 노트 삭제 (이 스토리에서 구현)

### 보안 및 권한

[Source: docs/architecture.md#3-보안]
- **권한 스코프**: 노트는 사용자 ID 스코프로 소유자만 삭제 가능
- **인증**: Supabase Auth 사용 (`getUser`로 현재 사용자 확인)
- id와 user_id 모두로 필터링하여 다른 사용자의 노트 삭제 방지

### 삭제 전략

- **영구 삭제**: 데이터베이스에서 노트를 완전히 제거
- **소프트 삭제 고려 사항** (미래 확장):
  - `deleted_at` 필드 추가
  - 휴지통 기능 구현
  - 복구 기능 추가
- 현재는 영구 삭제로 구현하고, 복구 기능은 Epic 2 범위 외

### Drizzle ORM 삭제 예시

```typescript
// 노트 삭제
const [deletedNote] = await db
  .delete(notes)
  .where(and(eq(notes.id, noteId), eq(notes.userId, user.id)))
  .returning()

if (!deletedNote) {
  return { success: false, error: '노트를 찾을 수 없거나 삭제 권한이 없습니다.' }
}
```

### shadcn/ui AlertDialog

- **설치**: `npx shadcn@latest add alert-dialog`
- **사용 패턴**:
  - AlertDialog - 루트 컨테이너
  - AlertDialogTrigger - 트리거 버튼
  - AlertDialogContent - 다이얼로그 내용
  - AlertDialogHeader - 헤더 영역
  - AlertDialogTitle - 제목
  - AlertDialogDescription - 설명
  - AlertDialogFooter - 푸터 (버튼 영역)
  - AlertDialogCancel - 취소 버튼
  - AlertDialogAction - 확인 버튼

### 캐시 무효화

- **revalidatePath**: 노트 삭제 후 관련 경로 캐시 무효화
  - `/notes` - 노트 목록
  - `/notes/${noteId}` - 노트 상세 (삭제된 노트)
- 삭제 후 리다이렉트 전에 revalidatePath 호출

### 프로젝트 구조

[Source: project layout]
- **노트 상세 페이지**: `/app/notes/[id]/` 디렉토리
  - `/app/notes/[id]/page.tsx` - 노트 상세 페이지 (수정)
  - `/app/notes/[id]/delete-dialog.tsx` - 삭제 확인 다이얼로그 (새로 생성)
- **노트 카드**: `/app/notes/note-card.tsx` (선택적 수정)
- **Server Actions**: `/app/notes/actions.ts` (deleteNote 추가)

### 파일 길이 제한

[Source: 프로젝트 규칙]
- 모든 파일은 **500 LOC 이하** 유지
- 파일은 모듈화되고 단일 목적을 가져야 함

### 주석 규칙

[Source: 프로젝트 규칙]
- 모든 파일은 **4줄의 헤더 주석**으로 시작:
  1. 코드베이스 내 정확한 파일 위치
  2. 이 파일이 무엇을 하는지 설명
  3. 이 파일이 왜 존재하는지 설명
  4. 관련된 2~4개 파일 목록

### UX 고려사항

- 삭제는 되돌릴 수 없는 작업이므로 명확한 확인 필요
- 삭제 버튼은 destructive variant 사용
- 모바일에서도 실수로 삭제하지 않도록 충분한 터치 영역
- 삭제 중에는 다이얼로그 닫기 방지

---

## Testing

### 테스트 표준

[Source: 프로젝트 규칙]
- **테스트 프레임워크**: Vitest
- **테스트 파일 위치**: `__tests__/` 디렉토리 또는 동일 위치에 `.test.ts`
- **테스트 커버리지 목표**: 80% 이상

### 테스트 항목

1. **Server Action 테스트** (`/app/notes/actions.test.ts`에 추가)
   - `deleteNote` 함수 유닛 테스트
   - 인증된 사용자가 자신의 노트 삭제 성공
   - 다른 사용자의 노트 삭제 시 실패
   - 존재하지 않는 노트 삭제 시 에러 반환
   - 비인증 사용자는 노트 삭제 실패
   - 삭제 성공 시 revalidatePath 호출 확인

2. **컴포넌트 테스트** (선택적)
   - 다이얼로그가 올바르게 렌더링되는지 확인
   - 취소 버튼 클릭 시 다이얼로그 닫힘
   - 삭제 버튼 클릭 시 deleteNote 호출
   - 로딩 상태 표시 확인

---

## Change Log

| Date       | Version | Description              | Author     |
|------------|---------|--------------------------|------------|
| 2025-10-14 | 1.0     | Story 2.5 초안 작성      | Bob (SM)   |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

없음

### Completion Notes List

- deleteNote Server Action 구현 완료
- AlertDialog 컴포넌트를 사용한 삭제 확인 다이얼로그 구현 완료
- 노트 상세 페이지에 삭제 기능 통합 완료
- 영구 삭제 전략 구현 (revalidatePath로 캐시 무효화)
- 모든 테스트 통과 (117 tests passed)

### File List

- `components/ui/alert-dialog.tsx` - AlertDialog 컴포넌트 (설치)
- `app/notes/actions.ts` - deleteNote Server Action 추가
- `app/notes/[id]/delete-dialog.tsx` - 삭제 확인 다이얼로그 (생성)
- `app/notes/[id]/page.tsx` - DeleteDialog 통합 (수정)
- `app/notes/actions.test.ts` - deleteNote 테스트 추가

---

## QA Results

_(QA 에이전트가 검토 후 작성)_

