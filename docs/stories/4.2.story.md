# Story 4.2: 노트 내용 기반 자동 요약 생성

## Status

Ready for Review

---

## Story

**As a** 사용자,  
**I want** 작성한 노트의 핵심 내용을 3-6개 불릿 포인트로 자동 요약받기를 원한다,  
**so that** 긴 노트의 핵심을 빠르게 파악하고 효율적으로 관리할 수 있다.

---

## Acceptance Criteria

1. 데이터베이스 스키마에 `summaries` 테이블이 추가되어야 한다
   - `id` (UUID, Primary Key)
   - `note_id` (UUID, Foreign Key to notes)
   - `user_id` (UUID, 사용자 ID)
   - `summary` (TEXT, 요약 내용)
   - `model` (TEXT, 사용된 AI 모델명)
   - `created_at` (TIMESTAMP)
   - 인덱스: note_id, user_id
   - 외래 키: note_id → notes(id) ON DELETE CASCADE

2. 요약 생성 Server Action이 구현되어야 한다
   - `generateSummary(noteId: string)` 함수
   - 노트 내용을 가져와 Gemini API로 요약 생성
   - 생성된 요약을 summaries 테이블에 저장
   - 인증된 사용자만 호출 가능
   - 자신의 노트만 요약 생성 가능 (권한 검증)

3. 요약은 3-6개의 불릿 포인트로 구성되어야 한다
   - 각 불릿은 한 문장으로 핵심 포인트 표현
   - 한국어로 자연스럽게 생성
   - 원문의 주요 아이디어를 정확하게 반영

4. 요약 생성 프롬프트가 최적화되어야 한다
   - 명확한 지시사항 (3-6개 불릿 포인트)
   - 한국어 출력 명시
   - 핵심 내용 추출 강조
   - 불필요한 설명 제외

5. 요약 조회 함수가 구현되어야 한다
   - `getSummary(noteId: string)` 함수
   - 특정 노트의 최신 요약 반환
   - 권한 검증 (자신의 노트만 조회)
   - 요약이 없으면 null 반환

6. 에러 처리가 구현되어야 한다
   - 노트를 찾을 수 없는 경우
   - 권한이 없는 경우
   - AI API 호출 실패
   - 토큰 제한 초과 (8k 토큰)
   - 타임아웃 (10초)
   - 모든 에러는 사용자 친화적인 한국어 메시지

7. 성능 최적화가 적용되어야 한다
   - 긴 노트는 토큰 제한에 맞게 자동 잘림
   - 요약 결과는 데이터베이스에 캐싱
   - 동일 노트에 대한 중복 요청 방지 (최근 요약이 있으면 재사용)

8. 단위 테스트가 작성되어야 한다
   - generateSummary 함수 테스트
   - getSummary 함수 테스트
   - 권한 검증 테스트
   - 에러 처리 테스트
   - Mocking을 사용한 독립적인 테스트

---

## Tasks / Subtasks

- [x] Task 1: 데이터베이스 스키마 수정 (AC: 1)
  - [x] `drizzle/schema.ts`에 `summaries` 테이블 정의 추가
    - [x] id: UUID, Primary Key
    - [x] noteId: UUID, Foreign Key
    - [x] userId: UUID, 사용자 ID
    - [x] summary: TEXT, 요약 내용
    - [x] model: TEXT, AI 모델명
    - [x] createdAt: TIMESTAMP
  - [x] 인덱스 추가
    - [x] note_id 인덱스 (조회 최적화)
    - [x] user_id 인덱스 (권한 검증)
  - [x] 외래 키 제약 조건 추가 (ON DELETE CASCADE)
  - [x] TypeScript 타입 정의 추가
    - [x] Summary 타입
    - [x] NewSummary 타입
  - [x] 마이그레이션 파일 생성
    - [x] `pnpm drizzle-kit generate`
    - [x] `pnpm drizzle-kit migrate` (개발 DB에 적용)

- [x] Task 2: 요약 생성 프롬프트 작성 (AC: 3, 4)
  - [x] `lib/gemini/prompts.ts` 파일 생성
  - [x] `createSummaryPrompt(content: string)` 함수 구현
    - [x] 시스템 지시사항 정의
    - [x] 3-6개 불릿 포인트 요청
    - [x] 한국어 출력 명시
    - [x] 핵심 내용 추출 강조
    - [x] 예시 포맷 제공
  - [x] 프롬프트 최적화
    - [x] 토큰 효율성 고려
    - [x] 명확하고 구체적인 지시
  - [x] createTagsPrompt 추가 구현 (향후 사용)

- [x] Task 3: 요약 생성 Server Action 구현 (AC: 2, 5, 6, 7)
  - [x] `app/notes/ai-actions.ts` 파일 생성 (새 파일)
  - [x] `generateSummary(noteId: string)` 함수 구현
    - [x] 인증 사용자 확인 (Supabase Auth)
    - [x] noteId 유효성 검증
    - [x] 노트 조회 (권한 검증 포함)
    - [x] 노트 내용 토큰 제한 체크 및 자동 잘림
    - [x] 기존 요약 확인 (5분 이내 생성된 요약이 있으면 재사용)
    - [x] Gemini API 호출 (요약 생성)
    - [x] 요약 결과 파싱 및 검증
    - [x] summaries 테이블에 저장
    - [x] 캐시 무효화 (revalidatePath)
    - [x] 성공 결과 반환
  - [x] `getSummary(noteId: string)` 함수 구현
    - [x] 인증 사용자 확인
    - [x] 권한 검증 (자신의 노트만)
    - [x] 최신 요약 조회
    - [x] 요약이 없으면 null 반환
  - [x] TypeScript 인터페이스 정의
    - [x] GenerateSummaryResult
    - [x] GetSummaryResult
  - [x] 에러 핸들링
    - [x] try-catch 블록
    - [x] Gemini API 에러 파싱
    - [x] 사용자 친화적 메시지 반환

- [x] Task 4: 프롬프트 유틸리티 테스트 (AC: 8)
  - [x] `lib/gemini/__tests__/prompts.test.ts` 생성
  - [x] createSummaryPrompt 함수 테스트
    - [x] 프롬프트 생성 확인
    - [x] 노트 내용이 포함되는지 확인
    - [x] 지시사항이 명확한지 확인
  - [x] 엣지 케이스 테스트
    - [x] 빈 내용
    - [x] 매우 긴 내용
    - [x] 특수 문자 포함
  - [x] createTagsPrompt 함수 테스트 추가

- [x] Task 5: AI Actions 단위 테스트 (AC: 8)
  - [x] `app/notes/__tests__/ai-actions.test.ts` 생성
  - [x] generateSummary 함수 테스트
    - [x] 인증 사용자가 자신의 노트 요약 생성 성공
    - [x] 비인증 사용자는 에러 반환
    - [x] 다른 사용자의 노트는 접근 불가 (존재하지 않는 노트 테스트)
    - [x] 존재하지 않는 노트는 에러 반환
    - [x] 유효하지 않은 noteId 에러 처리
    - [x] 최근 요약이 있으면 재사용 (캐싱 테스트)
  - [x] getSummary 함수 테스트
    - [x] 요약 조회 성공
    - [x] 권한 검증
    - [x] 요약이 없으면 null 반환
  - [x] Mocking 전략
    - [x] Supabase Auth 모킹
    - [x] Drizzle ORM 모킹
    - [x] Gemini API 모킹
    - [x] Next.js revalidatePath 모킹

- [x] Task 6: 통합 테스트
  - [x] 단위 테스트로 커버됨 (전체 216개 테스트 통과)
  - [ ] E2E 시나리오 수동 테스트 (UI 구현 후)
    - [ ] 노트 생성 → 요약 생성 → 요약 조회
    - [ ] 긴 노트의 요약 생성
    - [ ] 요약 재생성 방지 확인
  - [x] 성능 로직 구현
    - [x] 요약 생성 시간 제한 (Gemini 타임아웃 10초)
    - [x] 토큰 제한 체크 (7000 토큰)
  - [x] 에러 시나리오 처리
    - [x] API 키 누락 (Gemini 클라이언트에서 처리)
    - [x] 네트워크 에러 (parseGeminiError로 처리)
    - [x] 타임아웃 (Gemini 클라이언트에서 처리)

- [x] Task 7: 문서화
  - [x] 코드 주석 추가
    - [x] 각 함수에 JSDoc 주석
    - [x] 복잡한 로직 설명 (캐싱, 토큰 제한 등)
  - [x] 사용 예시 작성 (함수 JSDoc에 포함)
    - [x] generateSummary 호출 방법
    - [x] getSummary 호출 방법
  - [ ] README 업데이트 (다음 단계에서 진행)

---

## Dev Notes

### 기술 스택 및 아키텍처 정보

#### 데이터베이스 스키마

**summaries 테이블 구조**:
```typescript
export const summaries = pgTable(
  'summaries',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    noteId: uuid('note_id').notNull().references(() => notes.id, { onDelete: 'cascade' }),
    userId: uuid('user_id').notNull(),
    summary: text('summary').notNull(),
    model: text('model').notNull().default('gemini-2.0-flash'),
    createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  },
  (table) => ({
    noteIdIdx: index('summaries_note_id_idx').on(table.noteId),
    userIdIdx: index('summaries_user_id_idx').on(table.userId),
  })
);

export type Summary = typeof summaries.$inferSelect;
export type NewSummary = typeof summaries.$inferInsert;
```

[Source: docs/architecture.md - 데이터 모델]

#### 요약 생성 프롬프트

**프롬프트 구조**:
```
당신은 노트 내용을 분석하여 핵심을 요약하는 AI 어시스턴트입니다.

다음 노트의 내용을 3-6개의 불릿 포인트로 요약해주세요.

요구사항:
- 각 불릿은 한 문장으로 핵심 포인트를 표현
- 원문의 주요 아이디어를 정확하게 반영
- 한국어로 자연스럽게 작성
- 불필요한 설명이나 부연 설명 제외
- 불릿 포인트는 '-' 기호로 시작

노트 내용:
{content}
```

[Source: docs/prd.md - AI 자동 요약 (3~6 불릿 요약)]

#### Server Actions 패턴

기존 패턴 참고:
```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { db } from '@/lib/db'

export async function generateSummary(noteId: string) {
  try {
    // 1. 인증 확인
    const supabase = await createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    
    if (authError || !user) {
      return { success: false, error: '인증되지 않은 사용자입니다.' }
    }
    
    // 2. 노트 조회 및 권한 검증
    // 3. 요약 생성 (Gemini API)
    // 4. DB 저장
    // 5. 캐시 무효화
    
    return { success: true, summary: '...' }
  } catch (error) {
    return { success: false, error: '요약 생성 실패' }
  }
}
```

[Source: app/notes/actions.ts]

#### Gemini API 활용

스토리 4.1에서 구현된 클라이언트 사용:
```typescript
import { generateText } from '@/lib/gemini/client'
import { validatePrompt } from '@/lib/gemini/utils'
import { createSummaryPrompt } from '@/lib/gemini/prompts'

// 프롬프트 생성
const prompt = createSummaryPrompt(noteContent)

// 프롬프트 검증
const validation = validatePrompt(prompt, 8000)
if (!validation.valid) {
  // 토큰 제한 초과 시 내용 자르기
}

// 요약 생성
const response = await generateText(prompt, {
  temperature: 0.3, // 일관성 높은 요약
  maxOutputTokens: 500, // 요약은 짧게
})
```

[Source: lib/gemini/client.ts from Story 4.1]

#### 성능 최적화

1. **캐싱 전략**
   - 최근 5분 이내 생성된 요약은 재사용
   - 불필요한 API 호출 방지
   - 비용 절감

2. **토큰 관리**
   - 노트 내용이 8k 토큰 초과 시 자동 잘림
   - `truncateToTokenLimit()` 함수 활용
   - 긴 노트도 안전하게 처리

3. **타임아웃 설정**
   - 10초 타임아웃
   - 사용자 경험 보장

[Source: docs/epics/epic-4-ai-summarization-tagging.md]

#### 보안 고려사항

1. **권한 검증**
   - 노트 소유자만 요약 생성 가능
   - `WHERE user_id = {currentUserId}` 조건 필수
   - 다른 사용자의 노트 접근 차단

2. **데이터 격리**
   - summaries 테이블에도 user_id 저장
   - 사용자별 데이터 격리
   - 외래 키 제약으로 데이터 무결성 보장

[Source: docs/architecture.md - 보안]

#### 에러 처리

Gemini API 에러 활용:
```typescript
import { parseGeminiError } from '@/lib/gemini/errors'

try {
  // API 호출
} catch (error) {
  const geminiError = parseGeminiError(error)
  return {
    success: false,
    error: geminiError.message
  }
}
```

[Source: lib/gemini/errors.ts from Story 4.1]

### Testing

#### 테스트 파일 위치
```
lib/gemini/__tests__/
  prompts.test.ts              # 프롬프트 생성 테스트

app/notes/__tests__/
  ai-actions.test.ts           # AI Server Actions 테스트
```

[Source: 기존 테스트 구조 패턴]

#### 테스트 프레임워크
- **Vitest**: 단위 테스트
- **Mocking**: vi.mock() 사용
- **테스트 격리**: 각 테스트는 독립적

[Source: vitest.config.ts, package.json]

#### 테스트 커버리지

1. **요약 생성**
   - 정상 시나리오
   - 권한 검증
   - 토큰 제한 처리
   - 캐싱 동작
   - 에러 처리

2. **요약 조회**
   - 정상 조회
   - 권한 검증
   - 요약 없음 처리

3. **프롬프트 생성**
   - 다양한 입력에 대한 프롬프트 생성
   - 엣지 케이스 처리

#### 테스트 실행
```bash
pnpm test lib/gemini/prompts    # 프롬프트 테스트
pnpm test app/notes/ai-actions  # AI Actions 테스트
```

[Source: package.json scripts]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 스토리 최초 작성 | SM (Bob) |
| 2025-10-14 | 2.0 | 스토리 구현 완료 | DEV (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

None

### Completion Notes List

1. **데이터베이스 스키마 완료**
   - summaries 테이블 추가 (id, note_id, user_id, summary, model, created_at)
   - 인덱스 추가 (note_id_idx, user_id_idx)
   - 외래 키 제약 조건 추가 (ON DELETE CASCADE)
   - TypeScript 타입 정의 추가 (Summary, NewSummary)
   - 마이그레이션 생성 및 적용 완료 (0002_shiny_slapstick.sql)

2. **프롬프트 생성 모듈 완료**
   - `lib/gemini/prompts.ts` 구현
   - createSummaryPrompt() 함수: 3-6개 불릿 포인트 요약 프롬프트 생성
   - createTagsPrompt() 함수: 태그 생성 프롬프트 (향후 사용)
   - 명확한 지시사항 및 한국어 출력 명시
   - JSDoc 주석 포함

3. **AI Server Actions 완료**
   - `app/notes/ai-actions.ts` 구현
   - generateSummary() 함수: 노트 요약 생성
     - 인증 및 권한 검증
     - 5분 이내 요약 캐싱
     - 토큰 제한 체크 (7000 토큰)
     - Gemini API 호출
     - DB 저장 및 캐시 무효화
   - getSummary() 함수: 최신 요약 조회
     - 권한 검증
     - 요약 없으면 null 반환
   - TypeScript 인터페이스 정의 (GenerateSummaryResult, GetSummaryResult)
   - 에러 핸들링 및 사용자 친화적 메시지

4. **단위 테스트 완료**
   - `lib/gemini/__tests__/prompts.test.ts`: 12개 테스트
     - 프롬프트 생성 확인
     - 노트 내용 포함 확인
     - 지시사항 확인
     - 엣지 케이스 (빈 내용, 긴 내용, 특수 문자)
   - `app/notes/__tests__/ai-actions.test.ts`: 10개 테스트
     - generateSummary 함수 테스트 (인증, 권한, 캐싱, 에러)
     - getSummary 함수 테스트 (조회, 권한, null 처리)
     - Mocking 전략 (Supabase, Drizzle, Gemini API)
   - **전체 216개 테스트 모두 통과**

5. **성능 최적화**
   - 5분 이내 요약 캐싱으로 중복 API 호출 방지
   - 토큰 제한 체크 및 자동 잘림 (7000 토큰)
   - Gemini API 타임아웃 설정 (10초)
   - temperature 0.3으로 일관성 높은 요약
   - maxOutputTokens 500으로 짧은 요약

6. **보안 및 권한**
   - Supabase Auth 인증 검증
   - 노트 소유자만 요약 생성 가능
   - 사용자별 데이터 스코프 강제 (WHERE user_id)
   - 외래 키 제약으로 데이터 무결성 보장

7. **코드 품질**
   - 모든 함수에 JSDoc 주석
   - 4줄 헤더 주석 (파일 위치, 목적, 이유, 관련 파일)
   - 린트 에러 없음
   - TypeScript 타입 안전성
   - 명확한 에러 메시지

### File List

**생성된 파일**:
- `lib/gemini/prompts.ts` - 요약/태그 프롬프트 생성
- `lib/gemini/__tests__/prompts.test.ts` - 프롬프트 테스트
- `app/notes/ai-actions.ts` - 요약 생성/조회 Server Actions
- `app/notes/__tests__/ai-actions.test.ts` - AI Actions 테스트
- `drizzle/migrations/0002_shiny_slapstick.sql` - summaries 테이블 마이그레이션

**수정된 파일**:
- `drizzle/schema.ts` - summaries 테이블 정의 추가

---

## QA Results

_Not yet implemented_

